<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live Grading Assistant</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          animation: {
            'fadeIn': 'fadeIn 0.3s ease-in-out'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0', transform: 'scale(0.95)' },
              '100%': { opacity: '1', transform: 'scale(1)' }
            }
          }
        }
      }
    }
  </script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useMemo } = React;

const CONFIG = {
  AIRTABLE_API_KEY: 'patCUB0HwqgJr9nOr.d93cc816ba0e0dc0c22bbe5eaada139d84f864256b401446d1c2726da1247b4f',
  AIRTABLE_BASE_ID: 'appTwYDVvnYPB8D2N',
  N8N_WEBHOOK_URL: 'https://kringuette0.app.n8n.cloud/webhook/voice-grader',
  TABLES: {
    TEACHERS: 'Teachers',
    SECTIONS: 'Master Sections',
    STUDENTS: 'Student Roster',
    GRADES: 'Grades',
    GRADE_SCORES: 'Grade Scores',
  },
  FIELDS: {
    TEACHERS: { NAME: 'Name', EMAIL: 'Email', FIRST_NAME: 'First Name', LAST_NAME: 'Last Name', SECTIONS: 'Master Sections' },
    SECTIONS: { NAME: 'Section Name', SECTION_ID: 'Section ID', TEACHER_LINK: 'Teacher Link', STUDENT_ROSTER: 'Student Roster' },
    STUDENTS: { NAME: 'Name', EMAIL: 'Email', ID: 'ID', SECTIONS: 'Master Sections' },
    GRADES: { ASSIGNMENT: 'Assignment', STUDENT: 'Student', COMMENTS: 'Comments', FINAL_GRADE: 'Final Grade', SECTION: 'Section' },
    GRADE_SCORES: { GRADE: 'Grade', LABEL: 'Label', SCORE: 'Score', MAX: 'Max Points' }
  }
};

// FIXED Icon Component - No DOM mutation, React-controlled SVG rendering
const Icon = ({ name, className = "w-5 h-5" }) => {
  const ref = useRef(null);
  useEffect(() => {
    const luc = window.lucide;
    if (!luc || !luc.icons || !luc.icons[name]) {
      if (ref.current) ref.current.innerHTML = ""; // no icon found
      return;
    }
    // Render the SVG string *once per render* under React's control
    const svg = luc.icons[name].toSvg({ class: className });
    if (ref.current) ref.current.innerHTML = svg;
  }, [name, className]);

  return <span aria-hidden="true" ref={ref} />;
};

const blobToBase64 = (blob) =>
  new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => {
      const res = reader.result || '';
      const base64 = String(res).includes(',') ? String(res).split(',')[1] : String(res);
      resolve(base64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });

function chunk(arr, size = 10) {
  const out = [];
  for (let i = 0; i < arr.length; i += size) out.push(arr.slice(i, i + size));
  return out;
}

function GradingInterface() {
  const [step, setStep] = useState('teacher-select');
  const [isRecording, setIsRecording] = useState(false);
  const [isPaused, setIsPaused] = useState(false);
  const [recordingTime, setRecordingTime] = useState(0);

  const [teachers, setTeachers] = useState([]);
  const [teacherQuery, setTeacherQuery] = useState('');
  const [selectedTeacher, setSelectedTeacher] = useState(null);

  const [sections, setSections] = useState([]);
  const [sectionQuery, setSectionQuery] = useState('');
  const [selectedSection, setSelectedSection] = useState(null);

  const [students, setStudents] = useState([]);
  const [studentOrder, setStudentOrder] = useState([]);
  const [assignmentName, setAssignmentName] = useState('');
  const [rubricItems, setRubricItems] = useState([
    { name: 'Correctness', maxPoints: 25 },
    { name: 'Method', maxPoints: 25 },
    { name: 'Clarity', maxPoints: 25 },
    { name: 'Completeness', maxPoints: 25 }
  ]);
  const [grades, setGrades] = useState({});
  const [currentStudent, setCurrentStudent] = useState(null);

  const [transcript, setTranscript] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [editingStudent, setEditingStudent] = useState(null);
  const [editingField, setEditingField] = useState(null);
  const [sessionId, setSessionId] = useState(null);
  const [micError, setMicError] = useState(null);

  const [pendingCount, setPendingCount] = useState(0);
  const chunkIdRef = useRef(0);
  const isFlushingRef = useRef(false);

  const [isUploading, setIsUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState({ current: 0, total: 0 });
  const [uploadComplete, setUploadComplete] = useState(false);

  const [sortField, setSortField] = useState('name');
  const [sortDirection, setSortDirection] = useState('asc');

  // NEW: Separate recording approach - each spacebar press creates a new recording
  const mediaRecorderRef = useRef(null);
  const mediaStreamRef = useRef(null);
  const currentRecordingChunksRef = useRef([]); // Current recording chunks
  const completedRecordingsRef = useRef([]); // Array of completed recordings: {id, blob, studentName, timestamp}
  const recordingStartTimeRef = useRef(null);
  const [recordingSegments, setRecordingSegments] = useState([]); // For displaying tokens

  useEffect(() => {
    if (CONFIG.AIRTABLE_API_KEY === 'YOUR_AIRTABLE_API_KEY_HERE') {
      setError('Please configure your Airtable API key in the CONFIG section.');
    }
    loadTeachersFromAirtable();
  }, []);

  useEffect(() => {
    let interval;
    if (isRecording && !isPaused) {
      interval = setInterval(() => setRecordingTime(prev => prev + 1), 1000);
    }
    return () => clearInterval(interval);
  }, [isRecording, isPaused]);

  useEffect(() => {
    const handleKeyPress = (e) => {
      const tag = (e.target.tagName || '').toLowerCase();
      const isTyping = tag === 'input' || tag === 'textarea' || e.target.isContentEditable;
      if (isTyping) return;
      if (e.code === 'Space' && isRecording && !isPaused && !editingStudent) {
        e.preventDefault();
        sendChunkToWebhook(); // Just send, don't stop recording
      }
    };
    window.addEventListener('keydown', handleKeyPress);
    return () => window.removeEventListener('keydown', handleKeyPress);
  }, [isRecording, isPaused, editingStudent, rubricItems, students, grades, selectedTeacher, selectedSection, assignmentName, sessionId]);

  const airtableRequest = async (endpoint, options = {}) => {
    const url = `https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${endpoint}`;
    const response = await fetch(url, {
      ...options,
      headers: {
        'Authorization': `Bearer ${CONFIG.AIRTABLE_API_KEY}`,
        'Content-Type': 'application/json',
        ...options.headers
      }
    });
    if (!response.ok) throw new Error(`Airtable API error: ${response.status} ${response.statusText}`);
    return response.json();
  };

  const loadTeachersFromAirtable = async () => {
    setLoading(true);
    setError(null);
    try {
      const data = await airtableRequest(CONFIG.TABLES.TEACHERS);
      const tchs = (data.records || []).map(r => ({
        id: r.id,
        name: r.fields[CONFIG.FIELDS.TEACHERS.NAME] || 'Unknown',
        email: r.fields[CONFIG.FIELDS.TEACHERS.EMAIL] || '',
        firstName: r.fields[CONFIG.FIELDS.TEACHERS.FIRST_NAME] || '',
        lastName: r.fields[CONFIG.FIELDS.TEACHERS.LAST_NAME] || '',
        sectionLinks: r.fields[CONFIG.FIELDS.TEACHERS.SECTIONS] || []
      }));
      setTeachers(tchs);
    } catch (err) {
      console.error('Error loading teachers:', err);
      setError(`Failed to load teachers: ${err.message}`);
    } finally {
      setLoading(false);
    }
  };

  const loadSectionsForTeacher = async (tchr) => {
    if (!tchr || !tchr.sectionLinks || tchr.sectionLinks.length === 0) {
      setSections([]);
      return;
    }
    try {
      const sectionIds = tchr.sectionLinks;
      const formula = `OR(${sectionIds.map(id => `RECORD_ID()='${id}'`).join(',')})`;
      const data = await airtableRequest(`${CONFIG.TABLES.SECTIONS}?filterByFormula=${encodeURIComponent(formula)}`);
      const secs = (data.records || []).map(r => ({
        id: r.id,
        name: r.fields[CONFIG.FIELDS.SECTIONS.NAME] || 'Unknown Section',
        sectionId: r.fields[CONFIG.FIELDS.SECTIONS.SECTION_ID] || '',
        teacherLink: r.fields[CONFIG.FIELDS.SECTIONS.TEACHER_LINK] || [],
        studentRoster: r.fields[CONFIG.FIELDS.SECTIONS.STUDENT_ROSTER] || []
      }));
      setSections(secs);
    } catch (err) {
      console.error('Error loading sections:', err);
      setError(`Failed to load sections: ${err.message}`);
    }
  };

  const loadStudentsForSection = async (sec) => {
    if (!sec || !sec.studentRoster || sec.studentRoster.length === 0) {
      setStudents([]);
      setStudentOrder([]);
      return;
    }
    try {
      const studentIds = sec.studentRoster;
      const formula = `OR(${studentIds.map(id => `RECORD_ID()='${id}'`).join(',')})`;
      const data = await airtableRequest(`${CONFIG.TABLES.STUDENTS}?filterByFormula=${encodeURIComponent(formula)}`);
      const studs = (data.records || []).map(r => ({
        id: r.id,
        name: r.fields[CONFIG.FIELDS.STUDENTS.NAME] || 'Unknown',
        email: r.fields[CONFIG.FIELDS.STUDENTS.EMAIL] || '',
        studentId: r.fields[CONFIG.FIELDS.STUDENTS.ID] || '',
        sections: r.fields[CONFIG.FIELDS.STUDENTS.SECTIONS] || []
      }));
      setStudents(studs);
      const order = studs.map(s => s.id);
      setStudentOrder(order);
      const initGrades = {};
      studs.forEach(s => {
        initGrades[s.id] = { scores: {}, comments: '', completed: false };
      });
      setGrades(initGrades);
    } catch (err) {
      console.error('Error loading students:', err);
      setError(`Failed to load students: ${err.message}`);
    }
  };

  const handleTeacherSelect = (tchr) => {
    setSelectedTeacher(tchr);
    loadSectionsForTeacher(tchr);
    setStep('section-select');
  };

  const handleSectionSelect = (sec) => {
    setSelectedSection(sec);
    loadStudentsForSection(sec);
    setStep('assignment-setup');
  };

  const startGrading = async () => {
    if (!assignmentName.trim()) {
      setError('Please enter an assignment name.');
      return;
    }
    if (students.length === 0) {
      setError('No students loaded.');
      return;
    }

    const sid = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    setSessionId(sid);
    setStep('grading');
    setTranscript([]);
    setRecordingSegments([]);
    completedRecordingsRef.current = [];

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaStreamRef.current = stream;
      setMicError(null);
    } catch (err) {
      console.error('Microphone access error:', err);
      setMicError('Unable to access microphone. Please allow microphone access.');
    }
  };

  const toggleSort = (field) => {
    if (sortField === field) {
      setSortDirection(prev => prev === 'asc' ? 'desc' : 'asc');
    } else {
      setSortField(field);
      setSortDirection('asc');
    }
  };

  const startRecording = () => {
    if (!mediaStreamRef.current) {
      setMicError('Microphone not initialized.');
      return;
    }

    try {
      currentRecordingChunksRef.current = [];
      const recorder = new MediaRecorder(mediaStreamRef.current);
      mediaRecorderRef.current = recorder;
      recordingStartTimeRef.current = Date.now();

      recorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) {
          currentRecordingChunksRef.current.push(e.data);
        }
      };

      recorder.start();
      setIsRecording(true);
      setRecordingTime(0);
      setPendingCount(0);
    } catch (err) {
      console.error('Failed to start recording:', err);
      setError(`Failed to start recording: ${err.message}`);
    }
  };

  const pauseRecording = () => {
    if (!mediaRecorderRef.current) return;
    if (isPaused) {
      mediaRecorderRef.current.resume();
      setIsPaused(false);
    } else {
      mediaRecorderRef.current.pause();
      setIsPaused(true);
    }
  };

  const stopRecording = () => {
    if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
      mediaRecorderRef.current.stop();
    }
    setIsRecording(false);
    setIsPaused(false);
    setRecordingTime(0);
  };

  const sendChunkToWebhook = async () => {
    if (!mediaRecorderRef.current || mediaRecorderRef.current.state === 'inactive') return;
    if (currentRecordingChunksRef.current.length === 0) return;

    const newId = chunkIdRef.current++;
    const chunkBlob = new Blob(currentRecordingChunksRef.current, { type: 'audio/webm' });
    currentRecordingChunksRef.current = [];

    setRecordingSegments(prev => [...prev, { id: newId, status: 'processing' }]);
    setPendingCount(prev => prev + 1);

    try {
      const base64Audio = await blobToBase64(chunkBlob);
      const payload = {
        session_id: sessionId,
        chunk_id: newId,
        audio_data: base64Audio,
        teacher: selectedTeacher ? selectedTeacher.name : '',
        section: selectedSection ? selectedSection.name : '',
        assignment: assignmentName,
        rubric: rubricItems,
        students: students.map(s => s.name),
        current_grades: grades
      };

      const response = await fetch(CONFIG.N8N_WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) throw new Error(`Webhook error: ${response.status}`);

      const result = await response.json();

      setRecordingSegments(prev => prev.map(seg => seg.id === newId ? { ...seg, status: 'success' } : seg));
      setPendingCount(prev => Math.max(0, prev - 1));

      if (result.updates && Array.isArray(result.updates)) {
        setGrades(prevGrades => {
          const newGrades = { ...prevGrades };
          result.updates.forEach(upd => {
            const student = students.find(s => s.name.toLowerCase() === upd.student_name.toLowerCase());
            if (student && newGrades[student.id]) {
              if (upd.scores) {
                newGrades[student.id].scores = { ...newGrades[student.id].scores, ...upd.scores };
              }
              if (upd.comments) {
                newGrades[student.id].comments = upd.comments;
              }
              if (upd.completed !== undefined) {
                newGrades[student.id].completed = upd.completed;
              }
            }
          });
          return newGrades;
        });
      }

      if (result.transcript) {
        setTranscript(prev => [...prev, { id: newId, text: result.transcript, timestamp: new Date().toISOString() }]);
      }

    } catch (err) {
      console.error('Error sending chunk to webhook:', err);
      setRecordingSegments(prev => prev.map(seg => seg.id === newId ? { ...seg, status: 'error' } : seg));
      setPendingCount(prev => Math.max(0, prev - 1));
    }
  };

  const finishGrading = async () => {
    if (isRecording) {
      stopRecording();
      await new Promise(res => setTimeout(res, 500));
    }

    if (pendingCount > 0) {
      console.log(`⏳ Waiting for ${pendingCount} pending chunks...`);
      while (pendingCount > 0) {
        await new Promise(res => setTimeout(res, 500));
      }
      console.log('✅ All chunks processed');
    }

    setStep('review');
  };

  const editScore = (studentId, rubricName, value) => {
    setGrades(prev => ({
      ...prev,
      [studentId]: {
        ...prev[studentId],
        scores: { ...prev[studentId].scores, [rubricName]: value },
        completed: true
      }
    }));
  };

  const editComments = (studentId, value) => {
    setGrades(prev => ({
      ...prev,
      [studentId]: { ...prev[studentId], comments: value }
    }));
  };

  const uploadToAirtable = async () => {
    setIsUploading(true);
    setUploadProgress({ current: 0, total: 0 });
    setError(null);

    try {
      const completedGrades = Object.entries(grades).filter(([_, g]) => g.completed);
      if (completedGrades.length === 0) {
        setError('No completed grades to upload.');
        setIsUploading(false);
        return;
      }

      const totalOps = completedGrades.length * (1 + rubricItems.length);
      setUploadProgress({ current: 0, total: totalOps });
      let currentOp = 0;

      const gradeRecords = completedGrades.map(([studentId, g]) => {
        const student = students.find(s => s.id === studentId);
        const totalScore = rubricItems.reduce((sum, item) => sum + (g.scores[item.name] || 0), 0);
        return {
          fields: {
            [CONFIG.FIELDS.GRADES.ASSIGNMENT]: assignmentName,
            [CONFIG.FIELDS.GRADES.STUDENT]: [studentId],
            [CONFIG.FIELDS.GRADES.SECTION]: [selectedSection.id],
            [CONFIG.FIELDS.GRADES.COMMENTS]: g.comments || '',
            [CONFIG.FIELDS.GRADES.FINAL_GRADE]: totalScore
          }
        };
      });

      const createdPairs = [];
      const gradeChunks = chunk(gradeRecords, 10);

      for (const chunkData of gradeChunks) {
        const resp = await airtableRequest(CONFIG.TABLES.GRADES, {
          method: 'POST',
          body: JSON.stringify({ records: chunkData })
        });

        for (let i = 0; i < chunkData.length; i++) {
          const originalStudentLink = chunkData[i].fields[CONFIG.FIELDS.GRADES.STUDENT][0];
          const createdGradeId = resp.records[i].id;
          createdPairs.push({ studentId: originalStudentLink, gradeRecordId: createdGradeId });
        }

        currentOp += chunkData.length;
        setUploadProgress({ current: currentOp, total: totalOps });
      }

      const scoreRecords = [];
      for (const { studentId, gradeRecordId } of createdPairs) {
        const g = grades[studentId];
        if (!g) continue;

        for (const item of rubricItems) {
          const score = g.scores[item.name];
          if (score !== undefined && score !== null && score !== '') {
            scoreRecords.push({
              fields: {
                [CONFIG.FIELDS.GRADE_SCORES.GRADE]: [gradeRecordId],
                [CONFIG.FIELDS.GRADE_SCORES.LABEL]: item.name,
                [CONFIG.FIELDS.GRADE_SCORES.SCORE]: Number(score),
                [CONFIG.FIELDS.GRADE_SCORES.MAX]: item.maxPoints
              }
            });
          }
        }
      }

      const scoreChunks = chunk(scoreRecords, 10);
      for (const chunkData of scoreChunks) {
        await airtableRequest(CONFIG.TABLES.GRADE_SCORES, {
          method: 'POST',
          body: JSON.stringify({ records: chunkData })
        });
        currentOp += chunkData.length;
        setUploadProgress({ current: currentOp, total: totalOps });
      }

      console.log('✅ Upload complete!');
      setUploadComplete(true);
      setIsUploading(false);
      
      // FIXED: Navigate to results screen after successful upload
      setStep('results');

    } catch (err) {
      console.error('Upload error:', err);
      setError(`Upload failed: ${err.message}`);
      setIsUploading(false);
    }
  };

  const downloadAsExcel = async () => {
    try {
      const zip = new JSZip();
      const workbook = zip.folder('xl');
      const worksheets = workbook.folder('worksheets');
      const rels = workbook.folder('_rels');

      const rows = [
        ['Student Name', 'Student ID', ...rubricItems.map(item => item.name), 'Total', 'Comments']
      ];

      studentOrder.forEach(studentId => {
        const student = students.find(s => s.id === studentId);
        if (!student) return;
        const grade = grades[studentId] || { scores: {}, comments: '', completed: false };
        if (!grade.completed) return;

        const scores = rubricItems.map(item => grade.scores[item.name] ?? '');
        const total = rubricItems.reduce((sum, item) => sum + (grade.scores[item.name] || 0), 0);

        rows.push([
          student.name,
          student.studentId,
          ...scores,
          total,
          grade.comments
        ]);
      });

      let sheetData = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n';
      sheetData += '<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">\n';
      sheetData += '<sheetData>\n';

      rows.forEach((row, idx) => {
        sheetData += `<row r="${idx + 1}">\n`;
        row.forEach((cell, colIdx) => {
          const cellRef = String.fromCharCode(65 + colIdx) + (idx + 1);
          const cellType = typeof cell === 'number' ? 'n' : 'inlineStr';
          const cellValue = typeof cell === 'number'
            ? `<v>${cell}</v>`
            : `<is><t>${String(cell).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</t></is>`;
          sheetData += `<c r="${cellRef}" t="${cellType}">${cellValue}</c>\n`;
        });
        sheetData += '</row>\n';
      });

      sheetData += '</sheetData>\n</worksheet>';
      worksheets.file('sheet1.xml', sheetData);

      const contentTypes = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>
  <Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
</Types>`;
      zip.file('[Content_Types].xml', contentTypes);

      const relsXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>
</Relationships>`;
      zip.file('_rels/.rels', relsXml);

      const workbookXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  <sheets>
    <sheet name="Grades" sheetId="1" r:id="rId1"/>
  </sheets>
</workbook>`;
      workbook.file('workbook.xml', workbookXml);

      const workbookRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>
</Relationships>`;
      rels.file('workbook.xml.rels', workbookRels);

      const blob = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${assignmentName.replace(/[^a-z0-9]/gi, '_')}_grades.xlsx`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (err) {
      console.error('Error generating Excel:', err);
      setError(`Failed to generate Excel file: ${err.message}`);
    }
  };

  const resetApp = () => {
    setStep('teacher-select');
    setSelectedTeacher(null);
    setSelectedSection(null);
    setStudents([]);
    setStudentOrder([]);
    setGrades({});
    setTranscript([]);
    setRecordingSegments([]);
    completedRecordingsRef.current = [];
    setAssignmentName('');
    setIsRecording(false);
    setIsPaused(false);
    setRecordingTime(0);
    setUploadComplete(false);
    setSessionId(null);
    if (mediaStreamRef.current) {
      mediaStreamRef.current.getTracks().forEach(track => track.stop());
      mediaStreamRef.current = null;
    }
  };

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const getInitials = (name) => {
    if (!name) return '??';
    const parts = name.trim().split(/\s+/);
    if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
    return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
  };

  const filteredTeachers = useMemo(() => {
    if (!teacherQuery.trim()) return teachers;
    const q = teacherQuery.toLowerCase();
    return teachers.filter(t => t.name.toLowerCase().includes(q) || t.email.toLowerCase().includes(q));
  }, [teachers, teacherQuery]);

  const filteredSections = useMemo(() => {
    if (!sectionQuery.trim()) return sections;
    const q = sectionQuery.toLowerCase();
    return sections.filter(s => s.name.toLowerCase().includes(q) || s.sectionId.toLowerCase().includes(q));
  }, [sections, sectionQuery]);

  const maxTotal = rubricItems.reduce((sum, item) => sum + item.maxPoints, 0);

  const sortedStudents = useMemo(() => {
    if (!studentOrder || studentOrder.length === 0) return [];
    const list = studentOrder.map(id => {
      const student = students.find(s => s.id === id);
      if (!student) return null;
      const grade = grades[id] || { scores: {}, comments: '', completed: false };
      const total = rubricItems.reduce((sum, item) => sum + (grade.scores[item.name] || 0), 0);
      return { ...student, grade, total };
    }).filter(Boolean);

    return list.sort((a, b) => {
      let aVal, bVal;
      if (sortField === 'name') {
        aVal = a.name.toLowerCase();
        bVal = b.name.toLowerCase();
      } else if (sortField === 'status') {
        aVal = a.grade.completed ? 1 : 0;
        bVal = b.grade.completed ? 1 : 0;
      } else if (sortField === 'total') {
        aVal = a.total;
        bVal = b.total;
      } else {
        aVal = a.grade.scores[sortField] ?? -1;
        bVal = b.grade.scores[sortField] ?? -1;
      }
      if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
      if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
      return 0;
    });
  }, [studentOrder, students, grades, rubricItems, sortField, sortDirection]);

  const sortedStudentsForResults = useMemo(() => {
    const list = students.map(student => {
      const grade = grades[student.id] || { scores: {}, comments: '', completed: false };
      const total = rubricItems.reduce((sum, item) => sum + (grade.scores[item.name] || 0), 0);
      return { ...student, grade, total };
    });

    return list.sort((a, b) => {
      let aVal, bVal;
      if (sortField === 'name') {
        aVal = a.name.toLowerCase();
        bVal = b.name.toLowerCase();
      } else if (sortField === 'status') {
        aVal = a.grade.completed ? 1 : 0;
        bVal = b.grade.completed ? 1 : 0;
      } else if (sortField === 'total') {
        aVal = a.total;
        bVal = b.total;
      } else {
        aVal = a.grade.scores[sortField] ?? -1;
        bVal = b.grade.scores[sortField] ?? -1;
      }
      if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
      if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
      return 0;
    });
  }, [students, grades, rubricItems, sortField, sortDirection]);

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6 flex items-center justify-center">
        <div className="bg-white rounded-lg shadow-lg p-8">
          <div className="flex items-center space-x-3">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p className="text-lg text-gray-700">Loading teachers...</p>
          </div>
        </div>
      </div>
    );
  }

  if (error && step === 'teacher-select') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6 flex items-center justify-center">
        <div className="bg-white rounded-lg shadow-lg p-8 max-w-md">
          <div className="flex items-center space-x-3 text-red-600 mb-4">
            <Icon name="alert-circle" className="w-8 h-8" />
            <h2 className="text-xl font-bold">Error</h2>
          </div>
          <p className="text-gray-700 mb-6">{error}</p>
          <button
            onClick={() => {
              setError(null);
              loadTeachersFromAirtable();
            }}
            className="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700"
          >
            Retry
          </button>
        </div>
      </div>
    );
  }

  if (step === 'teacher-select') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-lg shadow-lg p-8 animate-fadeIn">
            <div className="flex items-center space-x-3 mb-6">
              <Icon name="user-circle" className="w-10 h-10 text-blue-600" />
              <h1 className="text-3xl font-bold text-gray-900">Select Teacher</h1>
            </div>

            <div className="mb-6">
              <div className="relative">
                <Icon name="search" className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                <input
                  type="text"
                  placeholder="Search teachers by name or email..."
                  value={teacherQuery}
                  onChange={(e) => setTeacherQuery(e.target.value)}
                  className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
            </div>

            <div className="space-y-3 max-h-96 overflow-y-auto">
              {filteredTeachers.length === 0 ? (
                <p className="text-center text-gray-500 py-8">No teachers found</p>
              ) : (
                filteredTeachers.map(teacher => (
                  <button
                    key={teacher.id}
                    onClick={() => handleTeacherSelect(teacher)}
                    className="w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-blue-50 transition-colors border border-gray-200 hover:border-blue-300"
                  >
                    <div className="flex items-center space-x-3">
                      <div className="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center font-semibold text-blue-600">
                        {getInitials(teacher.name)}
                      </div>
                      <div>
                        <p className="font-semibold text-gray-900">{teacher.name}</p>
                        <p className="text-sm text-gray-600">{teacher.email}</p>
                      </div>
                    </div>
                  </button>
                ))
              )}
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (step === 'section-select') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-lg shadow-lg p-8 animate-fadeIn">
            <button
              onClick={() => setStep('teacher-select')}
              className="mb-4 flex items-center text-blue-600 hover:text-blue-700 font-medium"
            >
              <Icon name="arrow-left" className="w-5 h-5 mr-2" />
              Back to Teacher Selection
            </button>

            <div className="flex items-center space-x-3 mb-6">
              <Icon name="book-open" className="w-10 h-10 text-blue-600" />
              <div>
                <h1 className="text-3xl font-bold text-gray-900">Select Section</h1>
                <p className="text-gray-600">Teacher: {selectedTeacher?.name}</p>
              </div>
            </div>

            <div className="mb-6">
              <div className="relative">
                <Icon name="search" className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                <input
                  type="text"
                  placeholder="Search sections..."
                  value={sectionQuery}
                  onChange={(e) => setSectionQuery(e.target.value)}
                  className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
            </div>

            <div className="space-y-3 max-h-96 overflow-y-auto">
              {filteredSections.length === 0 ? (
                <p className="text-center text-gray-500 py-8">No sections found</p>
              ) : (
                filteredSections.map(section => (
                  <button
                    key={section.id}
                    onClick={() => handleSectionSelect(section)}
                    className="w-full text-left p-4 bg-gray-50 rounded-lg hover:bg-blue-50 transition-colors border border-gray-200 hover:border-blue-300"
                  >
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="font-semibold text-gray-900">{section.name}</p>
                        <p className="text-sm text-gray-600">Section ID: {section.sectionId}</p>
                        <p className="text-sm text-gray-500 mt-1">{section.studentRoster.length} students</p>
                      </div>
                      <Icon name="chevron-right" className="w-6 h-6 text-gray-400" />
                    </div>
                  </button>
                ))
              )}
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (step === 'assignment-setup') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-lg shadow-lg p-8 animate-fadeIn">
            <button
              onClick={() => setStep('section-select')}
              className="mb-4 flex items-center text-blue-600 hover:text-blue-700 font-medium"
            >
              <Icon name="arrow-left" className="w-5 h-5 mr-2" />
              Back to Section Selection
            </button>

            <div className="flex items-center space-x-3 mb-6">
              <Icon name="clipboard-list" className="w-10 h-10 text-blue-600" />
              <div>
                <h1 className="text-3xl font-bold text-gray-900">Assignment Setup</h1>
                <p className="text-gray-600">{selectedSection?.name}</p>
              </div>
            </div>

            <div className="space-y-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Assignment Name
                </label>
                <input
                  type="text"
                  value={assignmentName}
                  onChange={(e) => setAssignmentName(e.target.value)}
                  placeholder="e.g., Midterm Exam, Quiz 1, Lab Report"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>

              <div>
                <div className="flex items-center justify-between mb-3">
                  <label className="block text-sm font-medium text-gray-700">
                    Rubric Items
                  </label>
                  <button
                    onClick={() => setRubricItems([...rubricItems, { name: '', maxPoints: 10 }])}
                    className="text-blue-600 hover:text-blue-700 font-medium text-sm flex items-center"
                  >
                    <Icon name="plus-circle" className="w-4 h-4 mr-1" />
                    Add Item
                  </button>
                </div>

                <div className="space-y-3">
                  {rubricItems.map((item, idx) => (
                    <div key={idx} className="flex items-center space-x-3">
                      <input
                        type="text"
                        value={item.name}
                        onChange={(e) => {
                          const newItems = [...rubricItems];
                          newItems[idx].name = e.target.value;
                          setRubricItems(newItems);
                        }}
                        placeholder="Criterion name"
                        className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                      <input
                        type="number"
                        value={item.maxPoints}
                        onChange={(e) => {
                          const newItems = [...rubricItems];
                          newItems[idx].maxPoints = parseInt(e.target.value) || 0;
                          setRubricItems(newItems);
                        }}
                        placeholder="Max"
                        className="w-24 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                      {rubricItems.length > 1 && (
                        <button
                          onClick={() => setRubricItems(rubricItems.filter((_, i) => i !== idx))}
                          className="p-2 text-red-600 hover:bg-red-50 rounded-lg"
                        >
                          <Icon name="x-circle" className="w-5 h-5" />
                        </button>
                      )}
                    </div>
                  ))}
                </div>
              </div>

              <div className="bg-blue-50 rounded-lg p-4">
                <div className="flex items-start space-x-3">
                  <Icon name="info" className="w-5 h-5 text-blue-600 mt-0.5" />
                  <div className="text-sm text-blue-900">
                    <p className="font-medium mb-1">Ready to start grading</p>
                    <p>{students.length} students loaded from {selectedSection?.name}</p>
                  </div>
                </div>
              </div>

              {error && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                  <div className="flex items-start space-x-3">
                    <Icon name="alert-circle" className="w-5 h-5 text-red-600 mt-0.5" />
                    <p className="text-sm text-red-800">{error}</p>
                  </div>
                </div>
              )}

              <button
                onClick={startGrading}
                className="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 flex items-center justify-center space-x-2"
              >
                <Icon name="play" className="w-5 h-5" />
                <span>Start Grading</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (step === 'grading') {
    const completedCount = Object.values(grades).filter(g => g.completed).length;
    const progressPercent = students.length > 0 ? (completedCount / students.length) * 100 : 0;

    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
        <div className="max-w-7xl mx-auto">
          <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h1 className="text-2xl font-bold text-gray-900">{assignmentName}</h1>
                <p className="text-gray-600">{selectedSection?.name}</p>
              </div>
              <button
                onClick={finishGrading}
                className="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 flex items-center space-x-2"
              >
                <Icon name="check-circle" className="w-5 h-5" />
                <span>Finish Grading</span>
              </button>
            </div>

            <div className="bg-gray-100 rounded-lg h-3 overflow-hidden">
              <div
                className="h-full bg-gradient-to-r from-blue-500 to-green-500 transition-all duration-300"
                style={{ width: `${progressPercent}%` }}
              />
            </div>
            <p className="text-sm text-gray-600 mt-2 text-center">
              {completedCount} of {students.length} students graded ({Math.round(progressPercent)}%)
            </p>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 space-y-6">
              <div className="bg-white rounded-lg shadow-lg p-6">
                <div className="flex items-center justify-between mb-6">
                  <h2 className="text-xl font-bold text-gray-900 flex items-center space-x-2">
                    <Icon name="mic" className="w-6 h-6 text-blue-600" />
                    <span>Recording Controls</span>
                  </h2>
                  {isRecording && (
                    <div className="flex items-center space-x-2">
                      <div className="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                      <span className="text-lg font-mono text-gray-700">{formatTime(recordingTime)}</span>
                    </div>
                  )}
                </div>

                {micError && (
                  <div className="mb-4 bg-red-50 border border-red-200 rounded-lg p-4">
                    <div className="flex items-start space-x-3">
                      <Icon name="alert-circle" className="w-5 h-5 text-red-600 mt-0.5" />
                      <p className="text-sm text-red-800">{micError}</p>
                    </div>
                  </div>
                )}

                <div className="flex items-center space-x-4 mb-6">
                  {!isRecording ? (
                    <button
                      onClick={startRecording}
                      className="flex-1 px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 flex items-center justify-center space-x-2"
                    >
                      <Icon name="mic" className="w-5 h-5" />
                      <span>Start Recording</span>
                    </button>
                  ) : (
                    <>
                      <button
                        onClick={pauseRecording}
                        className="flex-1 px-6 py-3 bg-yellow-600 text-white font-semibold rounded-lg hover:bg-yellow-700 flex items-center justify-center space-x-2"
                      >
                        <Icon name={isPaused ? 'play' : 'pause'} className="w-5 h-5" />
                        <span>{isPaused ? 'Resume' : 'Pause'}</span>
                      </button>
                      <button
                        onClick={stopRecording}
                        className="flex-1 px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 flex items-center justify-center space-x-2"
                      >
                        <Icon name="square" className="w-5 h-5" />
                        <span>Stop</span>
                      </button>
                    </>
                  )}
                </div>

                <div className="bg-blue-50 rounded-lg p-4">
                  <div className="flex items-start space-x-3">
                    <Icon name="info" className="w-5 h-5 text-blue-600 mt-0.5" />
                    <div className="text-sm text-blue-900">
                      <p className="font-medium mb-1">How to use:</p>
                      <ol className="list-decimal list-inside space-y-1">
                        <li>Click "Start Recording" to begin</li>
                        <li>Read student grades aloud (e.g., "John Smith, 20 points on correctness, great work!")</li>
                        <li>Press SPACEBAR to send the current segment for processing</li>
                        <li>Continue recording for the next student</li>
                        <li>Click "Finish Grading" when done</li>
                      </ol>
                    </div>
                  </div>
                </div>

                {recordingSegments.length > 0 && (
                  <div className="mt-6">
                    <h3 className="text-sm font-semibold text-gray-700 mb-3">Processing Status</h3>
                    <div className="flex flex-wrap gap-2">
                      {recordingSegments.map(seg => (
                        <div
                          key={seg.id}
                          className={`px-3 py-1 rounded-full text-xs font-medium ${
                            seg.status === 'processing' ? 'bg-yellow-100 text-yellow-800' :
                            seg.status === 'success' ? 'bg-green-100 text-green-800' :
                            'bg-red-100 text-red-800'
                          }`}
                        >
                          Segment {seg.id + 1}
                        </div>
                      ))}
                    </div>
                    {pendingCount > 0 && (
                      <p className="text-sm text-gray-600 mt-2">
                        {pendingCount} segment{pendingCount > 1 ? 's' : ''} processing...
                      </p>
                    )}
                  </div>
                )}
              </div>

              {transcript.length > 0 && (
                <div className="bg-white rounded-lg shadow-lg p-6">
                  <h2 className="text-xl font-bold text-gray-900 mb-4 flex items-center space-x-2">
                    <Icon name="file-text" className="w-6 h-6 text-blue-600" />
                    <span>Transcript</span>
                  </h2>
                  <div className="space-y-3 max-h-96 overflow-y-auto">
                    {transcript.map(entry => (
                      <div key={entry.id} className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <p className="text-sm text-gray-700">{entry.text}</p>
                        <p className="text-xs text-gray-500 mt-2">
                          {new Date(entry.timestamp).toLocaleTimeString()}
                        </p>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>

            <div className="space-y-6">
              <div className="bg-white rounded-lg shadow-lg p-6">
                <h2 className="text-xl font-bold text-gray-900 mb-4">Students</h2>
                <div className="space-y-2 max-h-[600px] overflow-y-auto">
                  {sortedStudents.map(student => {
                    const isCompleted = student.grade.completed;
                    return (
                      <div
                        key={student.id}
                        className={`p-3 rounded-lg border-2 transition-colors ${
                          isCompleted
                            ? 'bg-green-50 border-green-300'
                            : 'bg-gray-50 border-gray-200'
                        }`}
                      >
                        <div className="flex items-center justify-between">
                          <div className="flex items-center space-x-3">
                            <div className={`w-8 h-8 rounded-full flex items-center justify-center font-semibold text-sm ${
                              isCompleted ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'
                            }`}>
                              {getInitials(student.name)}
                            </div>
                            <div>
                              <p className="font-medium text-gray-900 text-sm">{student.name}</p>
                              <p className="text-xs text-gray-500">{student.studentId}</p>
                            </div>
                          </div>
                          {isCompleted && (
                            <Icon name="check-circle" className="w-5 h-5 text-green-600" />
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (step === 'review') {
    const completedCount = Object.values(grades).filter(g => g.completed).length;

    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
        <div className="max-w-7xl mx-auto">
          <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold text-gray-900">{assignmentName}</h1>
                <p className="text-gray-600">{selectedSection?.name}</p>
                <p className="text-sm text-gray-500 mt-1">{completedCount} of {students.length} students graded</p>
              </div>
              <div className="flex items-center space-x-3">
                {uploadComplete ? (
                  <div className="px-4 py-2 bg-green-100 text-green-800 font-semibold rounded-lg flex items-center space-x-2">
                    <Icon name="check-circle" className="w-5 h-5" />
                    <span>Upload Complete!</span>
                  </div>
                ) : (
                  <button
                    onClick={uploadToAirtable}
                    disabled={isUploading || completedCount === 0}
                    className={`px-6 py-2 font-semibold rounded-lg flex items-center space-x-2 ${
                      isUploading || completedCount === 0
                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                        : 'bg-blue-600 text-white hover:bg-blue-700'
                    }`}
                  >
                    <Icon name="upload" className="w-5 h-5" />
                    <span>{isUploading ? 'Uploading...' : 'Upload to Airtable'}</span>
                  </button>
                )}
                <button
                  onClick={downloadAsExcel}
                  className="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 flex items-center space-x-2"
                >
                  <Icon name="download" className="w-5 h-5" />
                  <span>Export Excel</span>
                </button>
                <button
                  onClick={resetApp}
                  className="px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 flex items-center space-x-2"
                >
                  <Icon name="refresh-cw" className="w-5 h-5" />
                  <span>New Session</span>
                </button>
              </div>
            </div>

            {isUploading && (
              <div className="mt-4">
                <div className="bg-blue-50 rounded-lg p-4">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-medium text-blue-900">
                      Uploading {uploadProgress.current} of {uploadProgress.total} records...
                    </span>
                    <span className="text-sm font-medium text-blue-900">
                      {uploadProgress.total > 0 ? Math.round((uploadProgress.current / uploadProgress.total) * 100) : 0}%
                    </span>
                  </div>
                  <div className="bg-blue-200 rounded-full h-2 overflow-hidden">
                    <div
                      className="h-full bg-blue-600 transition-all duration-300"
                      style={{
                        width: uploadProgress.total > 0
                          ? `${(uploadProgress.current / uploadProgress.total) * 100}%`
                          : '0%'
                      }}
                    />
                  </div>
                </div>
              </div>
            )}

            {error && (
              <div className="mt-4 bg-red-50 border border-red-200 rounded-lg p-4">
                <div className="flex items-start space-x-3">
                  <Icon name="alert-circle" className="w-5 h-5 text-red-600 mt-0.5" />
                  <p className="text-sm text-red-800">{error}</p>
                </div>
              </div>
            )}
          </div>

          <div className="bg-white rounded-lg shadow-lg overflow-hidden">
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th 
                      onClick={() => toggleSort('name')}
                      className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                    >
                      <div className="flex items-center gap-2">
                        Student Name
                        {sortField === 'name' && (
                          <Icon name={sortDirection === 'asc' ? 'arrow-up' : 'arrow-down'} className="w-4 h-4" />
                        )}
                      </div>
                    </th>
                    <th 
                      onClick={() => toggleSort('status')}
                      className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                    >
                      <div className="flex items-center gap-2">
                        Status
                        {sortField === 'status' && (
                          <Icon name={sortDirection === 'asc' ? 'arrow-up' : 'arrow-down'} className="w-4 h-4" />
                        )}
                      </div>
                    </th>
                    {rubricItems.map(item => (
                      <th 
                        key={item.name}
                        onClick={() => toggleSort(item.name)}
                        className="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                      >
                        <div className="flex items-center justify-center gap-2">
                          {item.name}
                          {sortField === item.name && (
                            <Icon name={sortDirection === 'asc' ? 'arrow-up' : 'arrow-down'} className="w-4 h-4" />
                          )}
                        </div>
                        <div className="text-xs font-normal text-gray-500 mt-1">/ {item.maxPoints}</div>
                      </th>
                    ))}
                    <th 
                      onClick={() => toggleSort('total')}
                      className="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                    >
                      <div className="flex items-center justify-center gap-2">
                        Total
                        {sortField === 'total' && (
                          <Icon name={sortDirection === 'asc' ? 'arrow-up' : 'arrow-down'} className="w-4 h-4" />
                        )}
                      </div>
                      <div className="text-xs font-normal text-gray-500 mt-1">/ {maxTotal}</div>
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                      Comments
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {sortedStudents.map((student, idx) => {
                    const isCompleted = student.grade.completed;
                    const isEditing = editingStudent === student.id;
                    
                    return (
                      <tr key={student.id} className={`${isCompleted ? 'bg-green-50' : 'bg-white'} hover:bg-blue-50 transition-colors`}>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="flex items-center">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center font-semibold text-sm ${isCompleted ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'}`}>
                              {getInitials(student.name)}
                            </div>
                            <div className="ml-3">
                              <div className="text-sm font-medium text-gray-900">{student.name}</div>
                              <div className="text-xs text-gray-500">ID: {student.studentId}</div>
                            </div>
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          {isCompleted ? (
                            <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                              Graded
                            </span>
                          ) : (
                            <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                              Not Graded
                            </span>
                          )}
                        </td>
                        {rubricItems.map(item => (
                          <td key={item.name} className="px-6 py-4 text-center whitespace-nowrap">
                            {isEditing && editingField === item.name ? (
                              <input
                                type="number"
                                value={student.grade.scores[item.name] ?? ''}
                                onChange={(e) => editScore(student.id, item.name, parseInt(e.target.value) || 0)}
                                onBlur={() => {
                                  setEditingStudent(null);
                                  setEditingField(null);
                                }}
                                autoFocus
                                className="w-20 px-2 py-1 border border-blue-300 rounded text-center focus:ring-2 focus:ring-blue-500"
                              />
                            ) : (
                              <button
                                onClick={() => {
                                  setEditingStudent(student.id);
                                  setEditingField(item.name);
                                }}
                                className={`text-sm font-semibold hover:text-blue-600 ${isCompleted ? 'text-gray-900' : 'text-gray-400'}`}
                              >
                                {student.grade.scores[item.name] ?? '--'}
                              </button>
                            )}
                          </td>
                        ))}
                        <td className="px-6 py-4 text-center whitespace-nowrap">
                          <span className={`text-lg font-bold ${isCompleted ? 'text-gray-900' : 'text-gray-400'}`}>
                            {isCompleted ? student.total : '--'}
                          </span>
                        </td>
                        <td className="px-6 py-4">
                          {isEditing && editingField === 'comments' ? (
                            <textarea
                              value={student.grade.comments}
                              onChange={(e) => editComments(student.id, e.target.value)}
                              onBlur={() => {
                                setEditingStudent(null);
                                setEditingField(null);
                              }}
                              autoFocus
                              className="w-full px-2 py-1 border border-blue-300 rounded focus:ring-2 focus:ring-blue-500"
                              rows="2"
                            />
                          ) : (
                            <button
                              onClick={() => {
                                setEditingStudent(student.id);
                                setEditingField('comments');
                              }}
                              className="text-sm text-gray-700 hover:text-blue-600 text-left w-full"
                            >
                              {student.grade.comments || <span className="text-gray-400 italic">Click to add comments</span>}
                            </button>
                          )}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (step === 'results') {
    const completedCount = sortedStudentsForResults.filter(s => s.grade.completed).length;

    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
        <div className="max-w-7xl mx-auto">
          <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold text-gray-900">Final Results</h1>
                <p className="text-gray-600">{assignmentName} - {selectedSection?.name}</p>
              </div>
              <div className="flex items-center space-x-3">
                <button
                  onClick={downloadAsExcel}
                  className="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 flex items-center space-x-2"
                >
                  <Icon name="download" className="w-5 h-5" />
                  <span>Export Excel</span>
                </button>
                <button
                  onClick={resetApp}
                  className="px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 flex items-center space-x-2"
                >
                  <Icon name="refresh-cw" className="w-5 h-5" />
                  <span>New Session</span>
                </button>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th 
                      onClick={() => toggleSort('name')}
                      className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                    >
                      <div className="flex items-center gap-2">
                        Student Name
                        {sortField === 'name' && (
                          <Icon name={sortDirection === 'asc' ? 'arrow-up' : 'arrow-down'} className="w-4 h-4" />
                        )}
                      </div>
                    </th>
                    <th 
                      onClick={() => toggleSort('status')}
                      className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                    >
                      <div className="flex items-center gap-2">
                        Status
                        {sortField === 'status' && (
                          <Icon name={sortDirection === 'asc' ? 'arrow-up' : 'arrow-down'} className="w-4 h-4" />
                        )}
                      </div>
                    </th>
                    {rubricItems.map(item => (
                      <th 
                        key={item.name}
                        onClick={() => toggleSort(item.name)}
                        className="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                      >
                        <div className="flex items-center justify-center gap-2">
                          {item.name}
                          {sortField === item.name && (
                            <Icon name={sortDirection === 'asc' ? 'arrow-up' : 'arrow-down'} className="w-4 h-4" />
                          )}
                        </div>
                        <div className="text-xs font-normal text-gray-500 mt-1">/ {item.maxPoints}</div>
                      </th>
                    ))}
                    <th 
                      onClick={() => toggleSort('total')}
                      className="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                    >
                      <div className="flex items-center justify-center gap-2">
                        Total
                        {sortField === 'total' && (
                          <Icon name={sortDirection === 'asc' ? 'arrow-up' : 'arrow-down'} className="w-4 h-4" />
                        )}
                      </div>
                      <div className="text-xs font-normal text-gray-500 mt-1">/ {maxTotal}</div>
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                      Comments
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {sortedStudentsForResults.map((student, idx) => {
                    const isCompleted = student.grade.completed;
                    const rowClass = isCompleted ? 'bg-green-50' : 'bg-white';
                    
                    return (
                      <tr key={student.id} className={`${rowClass} hover:bg-blue-50 transition-colors`}>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="flex items-center">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center font-semibold text-sm ${isCompleted ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'}`}>
                              {getInitials(student.name)}
                            </div>
                            <div className="ml-3">
                              <div className="text-sm font-medium text-gray-900">{student.name}</div>
                              <div className="text-xs text-gray-500">ID: {student.studentId}</div>
                            </div>
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          {isCompleted ? (
                            <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                              Graded
                            </span>
                          ) : (
                            <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                              Not Graded
                            </span>
                          )}
                        </td>
                        {rubricItems.map(item => (
                          <td key={item.name} className="px-6 py-4 text-center whitespace-nowrap">
                            <span className={`text-sm font-semibold ${isCompleted ? 'text-gray-900' : 'text-gray-400'}`}>
                              {student.grade.scores[item.name] ?? '--'}
                            </span>
                          </td>
                        ))}
                        <td className="px-6 py-4 text-center whitespace-nowrap">
                          <span className={`text-lg font-bold ${isCompleted ? 'text-gray-900' : 'text-gray-400'}`}>
                            {isCompleted ? student.total : '--'}
                          </span>
                        </td>
                        <td className="px-6 py-4">
                          <div className="text-sm text-gray-700 max-w-xs truncate" title={student.grade.comments}>
                            {student.grade.comments || <span className="text-gray-400 italic">No comments</span>}
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>

          <div className="mt-6 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h2 className="text-lg font-semibold text-gray-900 mb-4">Summary Statistics</h2>
            <div className="grid grid-cols-4 gap-4">
              <div className="text-center p-4 bg-blue-50 rounded-lg">
                <p className="text-3xl font-bold text-blue-600">{completedCount}</p>
                <p className="text-sm text-gray-600 mt-1">Students Graded</p>
              </div>
              <div className="text-center p-4 bg-purple-50 rounded-lg">
                <p className="text-3xl font-bold text-purple-600">
                  {completedCount > 0 
                    ? Math.round(sortedStudentsForResults.filter(s => s.grade.completed).reduce((sum, s) => sum + s.total, 0) / completedCount)
                    : '--'}
                </p>
                <p className="text-sm text-gray-600 mt-1">Average Score</p>
              </div>
              <div className="text-center p-4 bg-green-50 rounded-lg">
                <p className="text-3xl font-bold text-green-600">
                  {completedCount > 0
                    ? Math.max(...sortedStudentsForResults.filter(s => s.grade.completed).map(s => s.total))
                    : '--'}
                </p>
                <p className="text-sm text-gray-600 mt-1">Highest Score</p>
              </div>
              <div className="text-center p-4 bg-orange-50 rounded-lg">
                <p className="text-3xl font-bold text-orange-600">
                  {completedCount > 0
                    ? Math.min(...sortedStudentsForResults.filter(s => s.grade.completed).map(s => s.total))
                    : '--'}
                </p>
                <p className="text-sm text-gray-600 mt-1">Lowest Score</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Fallback for unknown step
  console.log('Current step:', step);
  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6 flex items-center justify-center">
      <div className="bg-white rounded-lg shadow-lg p-8 max-w-md">
        <h2 className="text-xl font-bold text-gray-900 mb-4">Unknown Step: {step}</h2>
        <p className="text-gray-600 mb-4">Something went wrong. Current step is: "{step}"</p>
        <button
          onClick={() => {
            console.log('Resetting to teacher-select');
            setStep('teacher-select');
            setSelectedTeacher(null);
            setSelectedSection(null);
            setStudents([]);
            setGrades({});
            setTranscript([]);
            setRecordingSegments([]);
            completedRecordingsRef.current = [];
            setUploadComplete(false);
            setAssignmentName('');
            setSessionId(null);
          }}
          className="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700"
        >
          Return to Start
        </button>
      </div>
    </div>
  );
}

ReactDOM.render(<GradingInterface />, document.getElementById('root'));
</script>
</body>
</html>
