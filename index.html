<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live Grading Assistant</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          animation: {
            'fadeIn': 'fadeIn 0.3s ease-in-out'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0', transform: 'scale(0.95)' },
              '100%': { opacity: '1', transform: 'scale(1)' }
            }
          }
        }
      }
    }
  </script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useMemo } = React;

const CONFIG = {
  AIRTABLE_API_KEY: 'patCUB0HwqgJr9nOr.d93cc816ba0e0dc0c22bbe5eaada139d84f864256b401446d1c2726da1247b4f',
  AIRTABLE_BASE_ID: 'appTwYDVvnYPB8D2N',
  N8N_WEBHOOK_URL: 'https://kringuette0.app.n8n.cloud/webhook/voice-grader',
  N8N_EMAIL_WEBHOOK_URL: 'YOUR_N8N_EMAIL_WEBHOOK_URL_HERE', // Add your n8n email webhook URL here
  TABLES: {
    TEACHERS: 'Teachers',
    SECTIONS: 'Master Sections',
    STUDENTS: 'Student Roster',
    GRADES: 'Grades',
    GRADE_SCORES: 'Grade Scores',
    RUBRICS: 'Rubrics',
  },
  FIELDS: {
    TEACHERS: { NAME: 'Name', EMAIL: 'Email', FIRST_NAME: 'First Name', LAST_NAME: 'Last Name', SECTIONS: 'Master Sections' },
    SECTIONS: { NAME: 'Section Name', SECTION_ID: 'Section ID', TEACHER_LINK: 'Teacher Link', STUDENT_ROSTER: 'Student Roster' },
    STUDENTS: { NAME: 'Name', EMAIL: 'Email', ID: 'ID', SECTIONS: 'Master Sections' },
    GRADES: { ASSIGNMENT: 'Assignment', STUDENT: 'Student', COMMENTS: 'Comments', FINAL_GRADE: 'Final Grade', SECTION: 'Section' },
    GRADE_SCORES: { GRADE: 'Grade', LABEL: 'Label', SCORE: 'Score', MAX: 'Max Points' },
    RUBRICS: { NAME: 'Rubric Name', TEACHER: 'Teacher', ITEMS: 'Items' }
  }
};

const Icon = ({ name, className = "w-5 h-5" }) => {
  const ref = React.useRef(null);
  React.useEffect(() => {
    // Wait for Lucide to be available
    const renderIcon = () => {
      const luc = window.lucide;
      if (!luc || !luc.icons || !luc.icons[name]) {
        if (ref.current) ref.current.innerHTML = ""; // no icon found
        return;
      }
      // Render the SVG string under React's control
      try {
        const svg = luc.icons[name].toSvg({ class: className });
        if (ref.current) ref.current.innerHTML = svg;
      } catch (err) {
        console.error('Error rendering icon:', name, err);
      }
    };

    // If Lucide is already loaded, render immediately
    if (window.lucide && window.lucide.icons) {
      renderIcon();
    } else {
      // Otherwise wait for it to load
      const checkInterval = setInterval(() => {
        if (window.lucide && window.lucide.icons) {
          clearInterval(checkInterval);
          renderIcon();
        }
      }, 50);
      
      return () => clearInterval(checkInterval);
    }
  }, [name, className]);

  return React.createElement('span', { 'aria-hidden': true, ref, style: { display: 'inline-block' } });
};

const blobToBase64 = (blob) =>
  new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => {
      const res = reader.result || '';
      const base64 = String(res).includes(',') ? String(res).split(',')[1] : String(res);
      resolve(base64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });

function chunk(arr, size = 10) {
  const out = [];
  for (let i = 0; i < arr.length; i += size) out.push(arr.slice(i, i + size));
  return out;
}

function GradingInterface() {
  const [step, setStep] = useState('teacher-select');
  const [isRecording, setIsRecording] = useState(false);
  const [isPaused, setIsPaused] = useState(false);
  const [recordingTime, setRecordingTime] = useState(0);

  const [teachers, setTeachers] = useState([]);
  const [teacherQuery, setTeacherQuery] = useState('');
  const [selectedTeacher, setSelectedTeacher] = useState(null);

  const [sections, setSections] = useState([]);
  const [sectionQuery, setSectionQuery] = useState('');
  const [selectedSections, setSelectedSections] = useState([]);

  const [students, setStudents] = useState([]);
  const [studentOrder, setStudentOrder] = useState([]);
  const [assignmentName, setAssignmentName] = useState('');
  const [savedRubrics, setSavedRubrics] = useState([]);
  const [allRubrics, setAllRubrics] = useState([]);
  const [showRubricBrowser, setShowRubricBrowser] = useState(false);
  const [rubricFilterTeacher, setRubricFilterTeacher] = useState(null);
  const [rubricSearchQuery, setRubricSearchQuery] = useState('');
  const [rubricItems, setRubricItems] = useState([
    { name: 'Correctness', maxPoints: 25 },
    { name: 'Method', maxPoints: 25 },
    { name: 'Clarity', maxPoints: 25 },
    { name: 'Completeness', maxPoints: 25 }
  ]);
  const [grades, setGrades] = useState({});
  const [currentStudent, setCurrentStudent] = useState(null);

  const [transcript, setTranscript] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [editingStudent, setEditingStudent] = useState(null);
  const [editingField, setEditingField] = useState(null);
  const [sessionId, setSessionId] = useState(null);
  const [micError, setMicError] = useState(null);

  const [pendingCount, setPendingCount] = useState(0);
  const chunkIdRef = useRef(0);
  const isFlushingRef = useRef(false);

  const [isUploading, setIsUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState({ current: 0, total: 0 });
  const [uploadComplete, setUploadComplete] = useState(false);

  const [sortField, setSortField] = useState('name');
  const [sortDirection, setSortDirection] = useState('asc');

  // NEW: Email draft state
  const [isDraftingEmail, setIsDraftingEmail] = useState(false);
  const [emailDraftSuccess, setEmailDraftSuccess] = useState(false);
  const [emailDraftError, setEmailDraftError] = useState(null);

  // NEW: Separate recording approach - each spacebar press creates a new recording
  const mediaRecorderRef = useRef(null);
  const mediaStreamRef = useRef(null);
  const currentRecordingChunksRef = useRef([]); // Current recording chunks
  const completedRecordingsRef = useRef([]); // Array of completed recordings: {id, blob, studentName, timestamp}
  const recordingStartTimeRef = useRef(null);
  const [recordingSegments, setRecordingSegments] = useState([]); // For displaying tokens

  useEffect(() => {
    if (CONFIG.AIRTABLE_API_KEY === 'YOUR_AIRTABLE_API_KEY_HERE') {
      setError('Please configure your Airtable API key in the CONFIG section.');
    }
    loadTeachersFromAirtable();
  }, []);

  useEffect(() => {
    let interval;
    if (isRecording && !isPaused) {
      interval = setInterval(() => {
        setRecordingTime(prev => prev + 1);
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [isRecording, isPaused]);

  useEffect(() => {
    const handleSpacePress = (e) => {
      if (step !== 'grading') return;
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.code !== 'Space') return;
      e.preventDefault();

      if (!isRecording) {
        startNewRecording();
      } else {
        stopCurrentRecording();
      }
    };

    const handleKeyPress = (e) => {
      if (step !== 'grading') return;
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.key === 'n') moveToNextStudent();
      if (e.key === 'p') moveToPreviousStudent();
    };

    window.addEventListener('keydown', handleSpacePress);
    window.addEventListener('keydown', handleKeyPress);
    return () => {
      window.removeEventListener('keydown', handleSpacePress);
      window.removeEventListener('keydown', handleKeyPress);
    };
  }, [step, isRecording, currentStudent, studentOrder]);

  async function loadTeachersFromAirtable() {
    try {
      const url = `https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${encodeURIComponent(CONFIG.TABLES.TEACHERS)}`;
      const resp = await fetch(url, {
        headers: { Authorization: `Bearer ${CONFIG.AIRTABLE_API_KEY}` }
      });
      if (!resp.ok) throw new Error('Failed to fetch teachers');
      const data = await resp.json();
      const mapped = data.records.map(rec => ({
        id: rec.id,
        name: rec.fields[CONFIG.FIELDS.TEACHERS.NAME] || '',
        email: rec.fields[CONFIG.FIELDS.TEACHERS.EMAIL] || '',
        firstName: rec.fields[CONFIG.FIELDS.TEACHERS.FIRST_NAME] || '',
        lastName: rec.fields[CONFIG.FIELDS.TEACHERS.LAST_NAME] || '',
        sectionsIds: rec.fields[CONFIG.FIELDS.TEACHERS.SECTIONS] || []
      }));
      setTeachers(mapped);
      setLoading(false);
    } catch (e) {
      setError(e.message);
      setLoading(false);
    }
  }

  async function handleTeacherSelect(teacher) {
    setSelectedTeacher(teacher);
    setLoading(true);
    try {
      const url = `https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${encodeURIComponent(CONFIG.TABLES.SECTIONS)}`;
      const resp = await fetch(url, {
        headers: { Authorization: `Bearer ${CONFIG.AIRTABLE_API_KEY}` }
      });
      if (!resp.ok) throw new Error('Failed to fetch sections');
      const data = await resp.json();
      const filtered = data.records
        .filter(rec => {
          const teacherLinks = rec.fields[CONFIG.FIELDS.SECTIONS.TEACHER_LINK] || [];
          return teacherLinks.includes(teacher.id);
        })
        .map(rec => ({
          id: rec.id,
          name: rec.fields[CONFIG.FIELDS.SECTIONS.NAME] || '',
          sectionId: rec.fields[CONFIG.FIELDS.SECTIONS.SECTION_ID] || '',
          studentRosterIds: rec.fields[CONFIG.FIELDS.SECTIONS.STUDENT_ROSTER] || []
        }));
      setSections(filtered);
      setLoading(false);
      setStep('section-select');
    } catch (e) {
      setError(e.message);
      setLoading(false);
    }
  }

  async function handleSectionConfirm() {
    if (selectedSections.length === 0) {
      alert('Please select at least one section.');
      return;
    }
    setLoading(true);
    try {
      const allStudentIds = [...new Set(selectedSections.flatMap(s => s.studentRosterIds))];
      const chunks = chunk(allStudentIds, 10);
      let allRecords = [];
      for (const ch of chunks) {
        const formula = `OR(${ch.map(id => `RECORD_ID()='${id}'`).join(',')})`;
        const url = `https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${encodeURIComponent(CONFIG.TABLES.STUDENTS)}?filterByFormula=${encodeURIComponent(formula)}`;
        const resp = await fetch(url, {
          headers: { Authorization: `Bearer ${CONFIG.AIRTABLE_API_KEY}` }
        });
        if (!resp.ok) throw new Error('Failed to fetch students');
        const data = await resp.json();
        allRecords = allRecords.concat(data.records);
      }
      const mapped = allRecords.map(rec => ({
        id: rec.id,
        name: rec.fields[CONFIG.FIELDS.STUDENTS.NAME] || '',
        email: rec.fields[CONFIG.FIELDS.STUDENTS.EMAIL] || '',
        studentId: rec.fields[CONFIG.FIELDS.STUDENTS.ID] || ''
      }));
      setStudents(mapped);
      const initialGrades = {};
      mapped.forEach(s => {
        initialGrades[s.id] = { scores: {}, comments: '', completed: false };
      });
      setGrades(initialGrades);
      setLoading(false);

      const rubUrl = `https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${encodeURIComponent(CONFIG.TABLES.RUBRICS)}`;
      const rubResp = await fetch(rubUrl, {
        headers: { Authorization: `Bearer ${CONFIG.AIRTABLE_API_KEY}` }
      });
      if (rubResp.ok) {
        const rubData = await rubResp.json();
        const rubrics = rubData.records.map(rec => ({
          id: rec.id,
          name: rec.fields[CONFIG.FIELDS.RUBRICS.NAME] || '',
          teacherId: (rec.fields[CONFIG.FIELDS.RUBRICS.TEACHER] || [])[0] || null,
          items: rec.fields[CONFIG.FIELDS.RUBRICS.ITEMS] || []
        }));
        setAllRubrics(rubrics);
        const teacherRubrics = rubrics.filter(r => r.teacherId === selectedTeacher.id);
        setSavedRubrics(teacherRubrics);
      }

      setStep('assignment-setup');
    } catch (e) {
      setError(e.message);
      setLoading(false);
    }
  }

  async function handleStartGrading() {
    if (!assignmentName.trim()) {
      alert('Please enter an assignment name.');
      return;
    }
    const order = [...students];
    setStudentOrder(order);
    setCurrentStudent(order[0] || null);
    setStep('grading');
    await initializeMicrophone();
  }

  async function initializeMicrophone() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaStreamRef.current = stream;
      setMicError(null);
    } catch (err) {
      setMicError('Microphone access denied. Please allow microphone access to record.');
      console.error('Microphone error:', err);
    }
  }

  async function startNewRecording() {
    if (!mediaStreamRef.current) {
      setMicError('Microphone not initialized.');
      return;
    }
    const recorder = new MediaRecorder(mediaStreamRef.current);
    mediaRecorderRef.current = recorder;
    currentRecordingChunksRef.current = [];
    recordingStartTimeRef.current = Date.now();

    recorder.ondataavailable = (e) => {
      if (e.data.size > 0) {
        currentRecordingChunksRef.current.push(e.data);
      }
    };

    recorder.onstop = async () => {
      const blob = new Blob(currentRecordingChunksRef.current, { type: 'audio/webm' });
      const recordingId = chunkIdRef.current++;
      const studentName = currentStudent ? currentStudent.name : 'Unknown';
      const timestamp = new Date().toISOString();
      completedRecordingsRef.current.push({ id: recordingId, blob, studentName, timestamp });
      setRecordingSegments(prev => [...prev, { id: recordingId, studentName, status: 'pending' }]);
      setPendingCount(prev => prev + 1);
    };

    recorder.start();
    setIsRecording(true);
    setRecordingTime(0);
  }

  function stopCurrentRecording() {
    if (mediaRecorderRef.current && mediaRecorderRef.current.state === 'recording') {
      mediaRecorderRef.current.stop();
      setIsRecording(false);
    }
  }

  function moveToNextStudent() {
    const idx = studentOrder.findIndex(s => s.id === currentStudent?.id);
    if (idx < studentOrder.length - 1) {
      setCurrentStudent(studentOrder[idx + 1]);
    }
  }

  function moveToPreviousStudent() {
    const idx = studentOrder.findIndex(s => s.id === currentStudent?.id);
    if (idx > 0) {
      setCurrentStudent(studentOrder[idx - 1]);
    }
  }

  async function flushAllPendingRecordings() {
    if (isFlushingRef.current) return;
    if (completedRecordingsRef.current.length === 0) {
      alert('No recordings to upload.');
      return;
    }
    isFlushingRef.current = true;
    setIsUploading(true);
    const total = completedRecordingsRef.current.length;
    setUploadProgress({ current: 0, total });
    const sid = sessionId || Date.now().toString();
    if (!sessionId) setSessionId(sid);

    try {
      for (let i = 0; i < completedRecordingsRef.current.length; i++) {
        const rec = completedRecordingsRef.current[i];
        const base64 = await blobToBase64(rec.blob);
        const payload = {
          session_id: sid,
          chunk_id: rec.id,
          student_name: rec.studentName,
          audio_base64: base64,
          timestamp: rec.timestamp
        };

        const resp = await fetch(CONFIG.N8N_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (resp.ok) {
          const result = await resp.json();
          setRecordingSegments(prev => prev.map(seg => seg.id === rec.id ? { ...seg, status: 'processed' } : seg));
          if (result.parsed_grade) {
            const studentId = result.parsed_grade.student_id || result.parsed_grade.student_name;
            const student = students.find(s => s.id === studentId || s.name === studentId || s.studentId === studentId);
            if (student) {
              setGrades(prevGrades => ({
                ...prevGrades,
                [student.id]: {
                  scores: result.parsed_grade.scores || {},
                  comments: result.parsed_grade.comments || '',
                  completed: true
                }
              }));
            }
          }
          setTranscript(prev => [...prev, { type: 'ai', text: result.ai_response || 'Processed' }]);
        } else {
          setRecordingSegments(prev => prev.map(seg => seg.id === rec.id ? { ...seg, status: 'error' } : seg));
        }
        setUploadProgress({ current: i + 1, total });
      }
      completedRecordingsRef.current = [];
      setPendingCount(0);
      setUploadComplete(true);
    } catch (err) {
      console.error('Error uploading recordings:', err);
      alert('Error uploading recordings: ' + err.message);
    } finally {
      isFlushingRef.current = false;
      setIsUploading(false);
    }
  }

  async function uploadToAirtable() {
    setLoading(true);
    try {
      const gradeRecords = [];
      const gradeScoreRecords = [];

      for (const student of students) {
        const g = grades[student.id];
        if (!g || !g.completed) continue;

        const total = rubricItems.reduce((sum, item) => sum + (g.scores[item.name] || 0), 0);

        const gradePayload = {
          fields: {
            [CONFIG.FIELDS.GRADES.ASSIGNMENT]: assignmentName,
            [CONFIG.FIELDS.GRADES.STUDENT]: [student.id],
            [CONFIG.FIELDS.GRADES.COMMENTS]: g.comments || '',
            [CONFIG.FIELDS.GRADES.FINAL_GRADE]: total,
            [CONFIG.FIELDS.GRADES.SECTION]: selectedSections.map(s => s.id)
          }
        };

        const gradeResp = await fetch(`https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${encodeURIComponent(CONFIG.TABLES.GRADES)}`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${CONFIG.AIRTABLE_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(gradePayload)
        });

        if (!gradeResp.ok) throw new Error('Failed to create grade record');
        const gradeData = await gradeResp.json();
        const gradeRecordId = gradeData.id;

        for (const item of rubricItems) {
          const score = g.scores[item.name] || 0;
          gradeScoreRecords.push({
            fields: {
              [CONFIG.FIELDS.GRADE_SCORES.GRADE]: [gradeRecordId],
              [CONFIG.FIELDS.GRADE_SCORES.LABEL]: item.name,
              [CONFIG.FIELDS.GRADE_SCORES.SCORE]: score,
              [CONFIG.FIELDS.GRADE_SCORES.MAX]: item.maxPoints
            }
          });
        }
      }

      const scoreChunks = chunk(gradeScoreRecords, 10);
      for (const ch of scoreChunks) {
        await fetch(`https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${encodeURIComponent(CONFIG.TABLES.GRADE_SCORES)}`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${CONFIG.AIRTABLE_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ records: ch })
        });
      }

      setLoading(false);
      setStep('results');
    } catch (err) {
      setError(err.message);
      setLoading(false);
    }
  }

  // NEW: Draft Email function
  async function handleDraftEmail() {
    if (CONFIG.N8N_EMAIL_WEBHOOK_URL === 'YOUR_N8N_EMAIL_WEBHOOK_URL_HERE') {
      alert('Please configure your n8n email webhook URL in the CONFIG section.');
      return;
    }

    setIsDraftingEmail(true);
    setEmailDraftError(null);
    setEmailDraftSuccess(false);

    try {
      // Prepare student data
      const studentData = students.map(student => {
        const g = grades[student.id];
        const total = g && g.completed 
          ? rubricItems.reduce((sum, item) => sum + (g.scores[item.name] || 0), 0)
          : null;

        return {
          name: student.name,
          email: student.email,
          studentId: student.studentId,
          completed: g?.completed || false,
          scores: g?.scores || {},
          comments: g?.comments || '',
          total: total
        };
      });

      // Prepare payload
      const payload = {
        teacher: {
          name: selectedTeacher.name,
          email: selectedTeacher.email,
          firstName: selectedTeacher.firstName,
          lastName: selectedTeacher.lastName
        },
        sections: selectedSections.map(section => ({
          id: section.sectionId,
          name: section.name
        })),
        assignment: {
          name: assignmentName,
          rubric: rubricItems.map(item => ({
            name: item.name,
            maxPoints: item.maxPoints
          })),
          maxTotal: rubricItems.reduce((sum, item) => sum + item.maxPoints, 0)
        },
        students: studentData,
        summary: {
          totalStudents: students.length,
          gradedStudents: students.filter(s => grades[s.id]?.completed).length,
          averageScore: studentData.filter(s => s.completed && s.total !== null).length > 0
            ? Math.round(studentData.filter(s => s.completed && s.total !== null).reduce((sum, s) => sum + s.total, 0) / studentData.filter(s => s.completed).length)
            : null
        },
        timestamp: new Date().toISOString()
      };

      // Send to n8n webhook
      const response = await fetch(CONFIG.N8N_EMAIL_WEBHOOK_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        throw new Error(`Failed to send data to n8n: ${response.statusText}`);
      }

      const result = await response.json();
      console.log('Email draft response:', result);
      
      setEmailDraftSuccess(true);
      setTimeout(() => setEmailDraftSuccess(false), 5000);
    } catch (err) {
      console.error('Error drafting email:', err);
      setEmailDraftError(err.message);
    } finally {
      setIsDraftingEmail(false);
    }
  }

  function handleManualEdit(studentId, field, value) {
    setGrades(prev => ({
      ...prev,
      [studentId]: {
        ...prev[studentId],
        [field]: value
      }
    }));
  }

  function handleScoreEdit(studentId, rubricName, value) {
    const parsed = parseInt(value, 10);
    if (isNaN(parsed)) return;
    setGrades(prev => ({
      ...prev,
      [studentId]: {
        ...prev[studentId],
        scores: {
          ...prev[studentId].scores,
          [rubricName]: parsed
        }
      }
    }));
  }

  function getInitials(name) {
    if (!name) return '?';
    const parts = name.split(' ').filter(p => p.length > 0);
    if (parts.length === 0) return '?';
    if (parts.length === 1) return parts[0][0].toUpperCase();
    return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
  }

  function toggleSort(field) {
    if (sortField === field) {
      setSortDirection(prev => prev === 'asc' ? 'desc' : 'asc');
    } else {
      setSortField(field);
      setSortDirection('asc');
    }
  }

  const maxTotal = rubricItems.reduce((sum, item) => sum + item.maxPoints, 0);

  const sortedStudentsForResults = useMemo(() => {
    const withTotals = students.map(student => {
      const g = grades[student.id];
      const total = g && g.completed 
        ? rubricItems.reduce((sum, item) => sum + (g.scores[item.name] || 0), 0)
        : 0;
      return { ...student, grade: g || { scores: {}, comments: '', completed: false }, total };
    });

    return withTotals.sort((a, b) => {
      let aVal, bVal;
      if (sortField === 'name') {
        aVal = a.name.toLowerCase();
        bVal = b.name.toLowerCase();
      } else if (sortField === 'status') {
        aVal = a.grade.completed ? 1 : 0;
        bVal = b.grade.completed ? 1 : 0;
      } else if (sortField === 'total') {
        aVal = a.total;
        bVal = b.total;
      } else {
        aVal = a.grade.scores[sortField] ?? 0;
        bVal = b.grade.scores[sortField] ?? 0;
      }

      if (sortDirection === 'asc') {
        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
      } else {
        return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
      }
    });
  }, [students, grades, rubricItems, sortField, sortDirection]);

  const completedCount = students.filter(s => grades[s.id]?.completed).length;

  const filteredTeachers = teachers.filter(t =>
    t.name.toLowerCase().includes(teacherQuery.toLowerCase())
  );

  const filteredSections = sections.filter(s =>
    s.name.toLowerCase().includes(sectionQuery.toLowerCase())
  );

  const currentIndex = studentOrder.findIndex(s => s.id === currentStudent?.id);
  const progressPercent = studentOrder.length > 0 ? ((currentIndex + 1) / studentOrder.length) * 100 : 0;

  function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m}:${s < 10 ? '0' : ''}${s}`;
  }

  async function saveRubricToAirtable(rubricName) {
    try {
      const payload = {
        fields: {
          [CONFIG.FIELDS.RUBRICS.NAME]: rubricName,
          [CONFIG.FIELDS.RUBRICS.TEACHER]: [selectedTeacher.id],
          [CONFIG.FIELDS.RUBRICS.ITEMS]: rubricItems.map(item => `${item.name}:${item.maxPoints}`).join(',')
        }
      };
      const resp = await fetch(`https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${encodeURIComponent(CONFIG.TABLES.RUBRICS)}`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${CONFIG.AIRTABLE_API_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });
      if (!resp.ok) throw new Error('Failed to save rubric');
      const data = await resp.json();
      const newRubric = {
        id: data.id,
        name: rubricName,
        teacherId: selectedTeacher.id,
        items: rubricItems.map(item => `${item.name}:${item.maxPoints}`)
      };
      setSavedRubrics(prev => [...prev, newRubric]);
      setAllRubrics(prev => [...prev, newRubric]);
      alert('Rubric saved successfully!');
    } catch (err) {
      alert('Error saving rubric: ' + err.message);
    }
  }

  function loadRubricFromSaved(rubric) {
    const items = rubric.items.map(str => {
      const [name, maxPoints] = str.split(':');
      return { name, maxPoints: parseInt(maxPoints, 10) };
    });
    setRubricItems(items);
    setShowRubricBrowser(false);
  }

  const filteredRubrics = allRubrics.filter(rubric => {
    const matchesSearch = rubric.name.toLowerCase().includes(rubricSearchQuery.toLowerCase());
    const matchesTeacher = !rubricFilterTeacher || rubric.teacherId === rubricFilterTeacher;
    return matchesSearch && matchesTeacher;
  });

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6 flex items-center justify-center">
        <div className="bg-white rounded-lg shadow-lg p-8 flex items-center gap-4">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          <p className="text-gray-700">Loading...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6 flex items-center justify-center">
        <div className="bg-white rounded-lg shadow-lg p-8 max-w-md">
          <h2 className="text-xl font-bold text-red-600 mb-4">Error</h2>
          <p className="text-gray-700 mb-4">{error}</p>
          <button
            onClick={() => window.location.reload()}
            className="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700"
          >
            Reload
          </button>
        </div>
      </div>
    );
  }

  if (step === 'teacher-select') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-lg shadow-lg p-8 animate-fadeIn">
            <h1 className="text-3xl font-bold text-gray-900 mb-6">Select Teacher</h1>
            <input
              type="text"
              placeholder="Search teachers..."
              value={teacherQuery}
              onChange={(e) => setTeacherQuery(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            <div className="grid gap-3 max-h-96 overflow-y-auto">
              {filteredTeachers.map(teacher => (
                <button
                  key={teacher.id}
                  onClick={() => handleTeacherSelect(teacher)}
                  className="text-left p-4 border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-300 transition-colors"
                >
                  <div className="font-semibold text-gray-900">{teacher.name}</div>
                  <div className="text-sm text-gray-500">{teacher.email}</div>
                </button>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (step === 'section-select') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-lg shadow-lg p-8 animate-fadeIn">
            <h1 className="text-3xl font-bold text-gray-900 mb-2">Select Sections</h1>
            <p className="text-gray-600 mb-6">Teacher: <span className="font-semibold">{selectedTeacher.name}</span></p>
            <input
              type="text"
              placeholder="Search sections..."
              value={sectionQuery}
              onChange={(e) => setSectionQuery(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            <div className="grid gap-3 max-h-96 overflow-y-auto mb-6">
              {filteredSections.map(section => {
                const isSelected = selectedSections.some(s => s.id === section.id);
                return (
                  <button
                    key={section.id}
                    onClick={() => {
                      if (isSelected) {
                        setSelectedSections(prev => prev.filter(s => s.id !== section.id));
                      } else {
                        setSelectedSections(prev => [...prev, section]);
                      }
                    }}
                    className={`text-left p-4 border rounded-lg transition-colors ${
                      isSelected
                        ? 'bg-blue-50 border-blue-500'
                        : 'border-gray-200 hover:bg-gray-50'
                    }`}
                  >
                    <div className="flex items-center gap-2">
                      <div className={`w-5 h-5 rounded border-2 flex items-center justify-center ${
                        isSelected ? 'bg-blue-600 border-blue-600' : 'border-gray-300'
                      }`}>
                        {isSelected && <Icon name="check" className="w-4 h-4 text-white" />}
                      </div>
                      <div className="flex-1">
                        <div className="font-semibold text-gray-900">{section.name}</div>
                        <div className="text-sm text-gray-500">ID: {section.sectionId}</div>
                      </div>
                    </div>
                  </button>
                );
              })}
            </div>
            <div className="flex gap-3">
              <button
                onClick={() => {
                  setStep('teacher-select');
                  setSelectedSections([]);
                }}
                className="px-6 py-2 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50"
              >
                Back
              </button>
              <button
                onClick={handleSectionConfirm}
                disabled={selectedSections.length === 0}
                className="flex-1 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
              >
                Continue ({selectedSections.length} selected)
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (step === 'assignment-setup') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-lg shadow-lg p-8 animate-fadeIn">
            <h1 className="text-3xl font-bold text-gray-900 mb-6">Assignment Setup</h1>
            
            <div className="mb-6">
              <label className="block text-sm font-semibold text-gray-700 mb-2">Assignment Name</label>
              <input
                type="text"
                value={assignmentName}
                onChange={(e) => setAssignmentName(e.target.value)}
                placeholder="e.g., Math Quiz 1"
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <div className="mb-6">
              <div className="flex items-center justify-between mb-4">
                <label className="block text-sm font-semibold text-gray-700">Grading Rubric</label>
                <div className="flex gap-2">
                  <button
                    onClick={() => setShowRubricBrowser(true)}
                    className="px-3 py-1 text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2"
                  >
                    <Icon name="folder-open" className="w-4 h-4" />
                    Browse Rubrics
                  </button>
                  <button
                    onClick={() => {
                      const name = prompt('Enter a name for this rubric:');
                      if (name && name.trim()) {
                        saveRubricToAirtable(name.trim());
                      }
                    }}
                    className="px-3 py-1 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2"
                  >
                    <Icon name="save" className="w-4 h-4" />
                    Save Rubric
                  </button>
                </div>
              </div>

              {showRubricBrowser && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                    <div className="p-6 border-b border-gray-200">
                      <div className="flex items-center justify-between mb-4">
                        <h2 className="text-2xl font-bold text-gray-900">Browse Rubrics</h2>
                        <button
                          onClick={() => setShowRubricBrowser(false)}
                          className="text-gray-400 hover:text-gray-600"
                        >
                          <Icon name="x" className="w-6 h-6" />
                        </button>
                      </div>
                      <input
                        type="text"
                        placeholder="Search rubrics..."
                        value={rubricSearchQuery}
                        onChange={(e) => setRubricSearchQuery(e.target.value)}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-3"
                      />
                      <div className="flex gap-2">
                        <button
                          onClick={() => setRubricFilterTeacher(null)}
                          className={`px-3 py-1 text-sm rounded-lg ${!rubricFilterTeacher ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                        >
                          All Teachers
                        </button>
                        <button
                          onClick={() => setRubricFilterTeacher(selectedTeacher.id)}
                          className={`px-3 py-1 text-sm rounded-lg ${rubricFilterTeacher === selectedTeacher.id ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                        >
                          My Rubrics
                        </button>
                      </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6">
                      <div className="space-y-3">
                        {filteredRubrics.map(rubric => {
                          const teacher = teachers.find(t => t.id === rubric.teacherId);
                          return (
                            <button
                              key={rubric.id}
                              onClick={() => loadRubricFromSaved(rubric)}
                              className="w-full text-left p-4 border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-300 transition-colors"
                            >
                              <div className="font-semibold text-gray-900 mb-1">{rubric.name}</div>
                              <div className="text-sm text-gray-500">
                                By: {teacher ? teacher.name : 'Unknown'}
                              </div>
                              <div className="text-xs text-gray-400 mt-1">
                                {rubric.items.length} items
                              </div>
                            </button>
                          );
                        })}
                        {filteredRubrics.length === 0 && (
                          <div className="text-center text-gray-500 py-8">
                            No rubrics found
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              )}

              <div className="space-y-3">
                {rubricItems.map((item, idx) => (
                  <div key={idx} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <input
                      type="text"
                      value={item.name}
                      onChange={(e) => {
                        const newItems = [...rubricItems];
                        newItems[idx].name = e.target.value;
                        setRubricItems(newItems);
                      }}
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Criterion name"
                    />
                    <input
                      type="number"
                      value={item.maxPoints}
                      onChange={(e) => {
                        const newItems = [...rubricItems];
                        newItems[idx].maxPoints = parseInt(e.target.value, 10) || 0;
                        setRubricItems(newItems);
                      }}
                      className="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Points"
                    />
                    <button
                      onClick={() => setRubricItems(rubricItems.filter((_, i) => i !== idx))}
                      className="p-2 text-red-600 hover:bg-red-50 rounded-lg"
                    >
                      <Icon name="trash-2" className="w-5 h-5" />
                    </button>
                  </div>
                ))}
                <button
                  onClick={() => setRubricItems([...rubricItems, { name: '', maxPoints: 0 }])}
                  className="w-full px-4 py-2 border-2 border-dashed border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 hover:border-gray-400 flex items-center justify-center gap-2"
                >
                  <Icon name="plus" className="w-5 h-5" />
                  Add Criterion
                </button>
              </div>
            </div>

            <div className="bg-blue-50 rounded-lg p-4 mb-6">
              <h3 className="font-semibold text-gray-900 mb-2">Students in Selected Sections</h3>
              <p className="text-gray-700">Total students: <span className="font-bold">{students.length}</span></p>
            </div>

            <div className="flex gap-3">
              <button
                onClick={() => {
                  setStep('section-select');
                }}
                className="px-6 py-2 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50"
              >
                Back
              </button>
              <button
                onClick={handleStartGrading}
                className="flex-1 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700"
              >
                Start Grading
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (step === 'grading') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
        <div className="max-w-6xl mx-auto">
          <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div className="flex items-center justify-between mb-4">
              <h1 className="text-2xl font-bold text-gray-900">Grading: {assignmentName}</h1>
              <div className="flex items-center gap-3">
                <div className="px-4 py-2 bg-blue-50 rounded-lg">
                  <span className="text-sm text-gray-600">Pending uploads: </span>
                  <span className="font-bold text-blue-600">{pendingCount}</span>
                </div>
                <button
                  onClick={flushAllPendingRecordings}
                  disabled={pendingCount === 0 || isUploading}
                  className="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2"
                >
                  {isUploading ? (
                    <>
                      <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                      Uploading...
                    </>
                  ) : (
                    <>
                      <Icon name="upload" className="w-5 h-5" />
                      Upload All
                    </>
                  )}
                </button>
              </div>
            </div>

            {isUploading && (
              <div className="mb-4">
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div
                    className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                    style={{ width: `${(uploadProgress.current / uploadProgress.total) * 100}%` }}
                  ></div>
                </div>
                <p className="text-sm text-gray-600 mt-1 text-center">
                  Uploading {uploadProgress.current} of {uploadProgress.total}...
                </p>
              </div>
            )}

            {uploadComplete && (
              <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-center gap-2">
                <Icon name="check-circle" className="w-5 h-5 text-green-600" />
                <span className="text-green-700 font-medium">All recordings uploaded successfully!</span>
              </div>
            )}

            <div className="w-full bg-gray-200 rounded-full h-3 mb-2">
              <div
                className="bg-blue-600 h-3 rounded-full transition-all duration-300"
                style={{ width: `${progressPercent}%` }}
              ></div>
            </div>
            <p className="text-sm text-gray-600 text-center">
              Student {currentIndex + 1} of {studentOrder.length}
            </p>
          </div>

          <div className="grid grid-cols-2 gap-6">
            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-bold text-gray-900 mb-4">Current Student</h2>
              {currentStudent ? (
                <div className="space-y-4">
                  <div className="flex items-center gap-4">
                    <div className="w-16 h-16 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-2xl">
                      {getInitials(currentStudent.name)}
                    </div>
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900">{currentStudent.name}</h3>
                      <p className="text-sm text-gray-500">ID: {currentStudent.studentId}</p>
                    </div>
                  </div>

                  {micError && (
                    <div className="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                      {micError}
                    </div>
                  )}

                  <div className="flex items-center justify-center gap-4 py-6">
                    <button
                      onClick={isRecording ? stopCurrentRecording : startNewRecording}
                      className={`w-20 h-20 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg transition-transform hover:scale-110 ${
                        isRecording ? 'bg-red-600 hover:bg-red-700 animate-pulse' : 'bg-blue-600 hover:bg-blue-700'
                      }`}
                    >
                      {isRecording ? (
                        <Icon name="square" className="w-8 h-8" />
                      ) : (
                        <Icon name="mic" className="w-8 h-8" />
                      )}
                    </button>
                    {isRecording && (
                      <div className="text-center">
                        <p className="text-2xl font-bold text-gray-900">{formatTime(recordingTime)}</p>
                        <p className="text-sm text-gray-500">Recording...</p>
                      </div>
                    )}
                  </div>

                  <div className="text-center text-sm text-gray-600 space-y-1">
                    <p><kbd className="px-2 py-1 bg-gray-100 rounded border border-gray-300">Space</kbd> to record/stop</p>
                    <p><kbd className="px-2 py-1 bg-gray-100 rounded border border-gray-300">N</kbd> next student | <kbd className="px-2 py-1 bg-gray-100 rounded border border-gray-300">P</kbd> previous student</p>
                  </div>

                  <div className="flex gap-2">
                    <button
                      onClick={moveToPreviousStudent}
                      disabled={currentIndex === 0}
                      className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 disabled:bg-gray-100 disabled:cursor-not-allowed"
                    >
                      ← Previous
                    </button>
                    <button
                      onClick={moveToNextStudent}
                      disabled={currentIndex >= studentOrder.length - 1}
                      className="flex-1 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                      Next →
                    </button>
                  </div>
                </div>
              ) : (
                <p className="text-gray-500">No students selected</p>
              )}
            </div>

            <div className="bg-white rounded-lg shadow-lg p-6">
              <h2 className="text-xl font-bold text-gray-900 mb-4">Recording Segments</h2>
              <div className="space-y-2 max-h-96 overflow-y-auto">
                {recordingSegments.map((seg) => (
                  <div
                    key={seg.id}
                    className={`p-3 rounded-lg border ${
                      seg.status === 'processed'
                        ? 'bg-green-50 border-green-200'
                        : seg.status === 'error'
                        ? 'bg-red-50 border-red-200'
                        : 'bg-gray-50 border-gray-200'
                    }`}
                  >
                    <div className="flex items-center justify-between">
                      <span className="font-medium text-gray-900">{seg.studentName}</span>
                      <span
                        className={`text-xs px-2 py-1 rounded-full ${
                          seg.status === 'processed'
                            ? 'bg-green-100 text-green-700'
                            : seg.status === 'error'
                            ? 'bg-red-100 text-red-700'
                            : 'bg-yellow-100 text-yellow-700'
                        }`}
                      >
                        {seg.status}
                      </span>
                    </div>
                  </div>
                ))}
                {recordingSegments.length === 0 && (
                  <p className="text-gray-500 text-center py-8">No recordings yet</p>
                )}
              </div>
            </div>
          </div>

          <div className="mt-6 bg-white rounded-lg shadow-lg p-6">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold text-gray-900">All Students</h2>
              <button
                onClick={uploadToAirtable}
                className="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 flex items-center gap-2"
              >
                <Icon name="check" className="w-5 h-5" />
                Finish & Save to Airtable
              </button>
            </div>
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Student</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                    {rubricItems.map(item => (
                      <th key={item.name} className="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">
                        {item.name}
                        <div className="text-xs font-normal text-gray-500 mt-1">/ {item.maxPoints}</div>
                      </th>
                    ))}
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Comments</th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {students.map(student => {
                    const g = grades[student.id] || { scores: {}, comments: '', completed: false };
                    const isCompleted = g.completed;
                    const rowClass = isCompleted ? 'bg-green-50' : 'bg-white';
                    
                    return (
                      <tr key={student.id} className={`${rowClass} hover:bg-blue-50 transition-colors`}>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="flex items-center">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center font-semibold text-sm ${isCompleted ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'}`}>
                              {getInitials(student.name)}
                            </div>
                            <div className="ml-3">
                              <div className="text-sm font-medium text-gray-900">{student.name}</div>
                              <div className="text-xs text-gray-500">ID: {student.studentId}</div>
                            </div>
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          {isCompleted ? (
                            <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                              Graded
                            </span>
                          ) : (
                            <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                              Not Graded
                            </span>
                          )}
                        </td>
                        {rubricItems.map(item => (
                          <td key={item.name} className="px-6 py-4 text-center whitespace-nowrap">
                            {editingStudent === student.id && editingField === item.name ? (
                              <input
                                type="number"
                                value={g.scores[item.name] ?? ''}
                                onChange={(e) => handleScoreEdit(student.id, item.name, e.target.value)}
                                onBlur={() => {
                                  setEditingStudent(null);
                                  setEditingField(null);
                                }}
                                className="w-16 px-2 py-1 border border-blue-300 rounded text-center focus:ring-2 focus:ring-blue-500"
                                autoFocus
                              />
                            ) : (
                              <span
                                onClick={() => {
                                  setEditingStudent(student.id);
                                  setEditingField(item.name);
                                }}
                                className="text-sm font-semibold text-gray-900 cursor-pointer hover:text-blue-600"
                              >
                                {g.scores[item.name] ?? '--'}
                              </span>
                            )}
                          </td>
                        ))}
                        <td className="px-6 py-4">
                          {editingStudent === student.id && editingField === 'comments' ? (
                            <input
                              type="text"
                              value={g.comments || ''}
                              onChange={(e) => handleManualEdit(student.id, 'comments', e.target.value)}
                              onBlur={() => {
                                setEditingStudent(null);
                                setEditingField(null);
                              }}
                              className="w-full px-2 py-1 border border-blue-300 rounded focus:ring-2 focus:ring-blue-500"
                              autoFocus
                            />
                          ) : (
                            <div
                              onClick={() => {
                                setEditingStudent(student.id);
                                setEditingField('comments');
                              }}
                              className="text-sm text-gray-700 max-w-xs truncate cursor-pointer hover:text-blue-600"
                              title={g.comments}
                            >
                              {g.comments || <span className="text-gray-400 italic">Click to add</span>}
                            </div>
                          )}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (step === 'results') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
        <div className="max-w-7xl mx-auto">
          <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
            <div className="flex items-center justify-between mb-6">
              <div>
                <h1 className="text-3xl font-bold text-gray-900 mb-2">Grading Complete!</h1>
                <p className="text-gray-600">Assignment: <span className="font-semibold">{assignmentName}</span></p>
                <p className="text-gray-600">Teacher: <span className="font-semibold">{selectedTeacher.name}</span></p>
              </div>
              <div className="flex gap-3">
                <button
                  onClick={handleDraftEmail}
                  disabled={isDraftingEmail}
                  className="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2 transition-colors"
                >
                  {isDraftingEmail ? (
                    <>
                      <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                      Drafting...
                    </>
                  ) : (
                    <>
                      <Icon name="mail" className="w-5 h-5" />
                      Draft Email
                    </>
                  )}
                </button>
                <button
                  onClick={() => {
                    setStep('teacher-select');
                    setSelectedTeacher(null);
                    setSelectedSections([]);
                    setStudents([]);
                    setGrades({});
                    setTranscript([]);
                    setRecordingSegments([]);
                    completedRecordingsRef.current = [];
                    setUploadComplete(false);
                    setAssignmentName('');
                    setSessionId(null);
                    setEmailDraftSuccess(false);
                    setEmailDraftError(null);
                  }}
                  className="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 flex items-center gap-2"
                >
                  <Icon name="plus" className="w-5 h-5" />
                  Start New Session
                </button>
              </div>
            </div>

            {emailDraftSuccess && (
              <div className="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg flex items-center gap-3">
                <Icon name="check-circle" className="w-6 h-6 text-green-600" />
                <div>
                  <p className="text-green-700 font-medium">Email draft sent successfully!</p>
                  <p className="text-green-600 text-sm">Check your n8n workflow for the drafted email.</p>
                </div>
              </div>
            )}

            {emailDraftError && (
              <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg flex items-center gap-3">
                <Icon name="alert-circle" className="w-6 h-6 text-red-600" />
                <div>
                  <p className="text-red-700 font-medium">Failed to draft email</p>
                  <p className="text-red-600 text-sm">{emailDraftError}</p>
                </div>
              </div>
            )}

            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th 
                      onClick={() => toggleSort('name')}
                      className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                    >
                      <div className="flex items-center gap-2">
                        Student Name
                        {sortField === 'name' && (
                          <Icon name={sortDirection === 'asc' ? 'arrow-up' : 'arrow-down'} className="w-4 h-4" />
                        )}
                      </div>
                    </th>
                    <th 
                      onClick={() => toggleSort('status')}
                      className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                    >
                      <div className="flex items-center gap-2">
                        Status
                        {sortField === 'status' && (
                          <Icon name={sortDirection === 'asc' ? 'arrow-up' : 'arrow-down'} className="w-4 h-4" />
                        )}
                      </div>
                    </th>
                    {rubricItems.map(item => (
                      <th 
                        key={item.name}
                        onClick={() => toggleSort(item.name)}
                        className="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                      >
                        <div className="flex items-center justify-center gap-2">
                          {item.name}
                          {sortField === item.name && (
                            <Icon name={sortDirection === 'asc' ? 'arrow-up' : 'arrow-down'} className="w-4 h-4" />
                          )}
                        </div>
                        <div className="text-xs font-normal text-gray-500 mt-1">/ {item.maxPoints}</div>
                      </th>
                    ))}
                    <th 
                      onClick={() => toggleSort('total')}
                      className="px-6 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none"
                    >
                      <div className="flex items-center justify-center gap-2">
                        Total
                        {sortField === 'total' && (
                          <Icon name={sortDirection === 'asc' ? 'arrow-up' : 'arrow-down'} className="w-4 h-4" />
                        )}
                      </div>
                      <div className="text-xs font-normal text-gray-500 mt-1">/ {maxTotal}</div>
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                      Comments
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {sortedStudentsForResults.map((student, idx) => {
                    const isCompleted = student.grade.completed;
                    const rowClass = isCompleted ? 'bg-green-50' : 'bg-white';
                    
                    return (
                      <tr key={student.id} className={`${rowClass} hover:bg-blue-50 transition-colors`}>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="flex items-center">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center font-semibold text-sm ${isCompleted ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'}`}>
                              {getInitials(student.name)}
                            </div>
                            <div className="ml-3">
                              <div className="text-sm font-medium text-gray-900">{student.name}</div>
                              <div className="text-xs text-gray-500">ID: {student.studentId}</div>
                            </div>
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          {isCompleted ? (
                            <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                              Graded
                            </span>
                          ) : (
                            <span className="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                              Not Graded
                            </span>
                          )}
                        </td>
                        {rubricItems.map(item => (
                          <td key={item.name} className="px-6 py-4 text-center whitespace-nowrap">
                            <span className={`text-sm font-semibold ${isCompleted ? 'text-gray-900' : 'text-gray-400'}`}>
                              {student.grade.scores[item.name] ?? '--'}
                            </span>
                          </td>
                        ))}
                        <td className="px-6 py-4 text-center whitespace-nowrap">
                          <span className={`text-lg font-bold ${isCompleted ? 'text-gray-900' : 'text-gray-400'}`}>
                            {isCompleted ? student.total : '--'}
                          </span>
                        </td>
                        <td className="px-6 py-4">
                          <div className="text-sm text-gray-700 max-w-xs truncate" title={student.grade.comments}>
                            {student.grade.comments || <span className="text-gray-400 italic">No comments</span>}
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>

          <div className="mt-6 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h2 className="text-lg font-semibold text-gray-900 mb-4">Summary Statistics</h2>
            <div className="grid grid-cols-4 gap-4">
              <div className="text-center p-4 bg-blue-50 rounded-lg">
                <p className="text-3xl font-bold text-blue-600">{completedCount}</p>
                <p className="text-sm text-gray-600 mt-1">Students Graded</p>
              </div>
              <div className="text-center p-4 bg-purple-50 rounded-lg">
                <p className="text-3xl font-bold text-purple-600">
                  {completedCount > 0 
                    ? Math.round(sortedStudentsForResults.filter(s => s.grade.completed).reduce((sum, s) => sum + s.total, 0) / completedCount)
                    : '--'}
                </p>
                <p className="text-sm text-gray-600 mt-1">Average Score</p>
              </div>
              <div className="text-center p-4 bg-green-50 rounded-lg">
                <p className="text-3xl font-bold text-green-600">
                  {completedCount > 0
                    ? Math.max(...sortedStudentsForResults.filter(s => s.grade.completed).map(s => s.total))
                    : '--'}
                </p>
                <p className="text-sm text-gray-600 mt-1">Highest Score</p>
              </div>
              <div className="text-center p-4 bg-orange-50 rounded-lg">
                <p className="text-3xl font-bold text-orange-600">
                  {completedCount > 0
                    ? Math.min(...sortedStudentsForResults.filter(s => s.grade.completed).map(s => s.total))
                    : '--'}
                </p>
                <p className="text-sm text-gray-600 mt-1">Lowest Score</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Fallback for unknown step
  console.log('Current step:', step);
  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6 flex items-center justify-center">
      <div className="bg-white rounded-lg shadow-lg p-8 max-w-md">
        <h2 className="text-xl font-bold text-gray-900 mb-4">Unknown Step: {step}</h2>
        <p className="text-gray-600 mb-4">Something went wrong. Current step is: "{step}"</p>
        <button
          onClick={() => {
            console.log('Resetting to teacher-select');
            setStep('teacher-select');
            setSelectedTeacher(null);
            setSelectedSections([]);
            setStudents([]);
            setGrades({});
            setTranscript([]);
            setRecordingSegments([]);
            completedRecordingsRef.current = [];
            setUploadComplete(false);
            setAssignmentName('');
            setSessionId(null);
          }}
          className="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700"
        >
          Return to Start
        </button>
      </div>
    </div>
  );
}

ReactDOM.render(<GradingInterface />, document.getElementById('root'));
</script>
</body>
</html>
