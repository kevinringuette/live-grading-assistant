<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Grading Assistant</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const CONFIG = {
            AIRTABLE_API_KEY: 'patCUB0HwqgJr9nOr.d93cc816ba0e0dc0c22bbe5eaada139d84f864256b401446d1c2726da1247b4f',
            AIRTABLE_BASE_ID: 'appTwYDVvnYPB8D2N',
            
            // Your n8n Webhook URL
            N8N_WEBHOOK_URL: 'https://kringuette0.app.n8n.cloud/webhook-test/voice-grader',
            TABLES: {
                TEACHERS: 'Teachers',
                SECTIONS: 'Master Sections',
                STUDENTS: 'Student Roster',
                GRADES: 'Grades'
            },
            FIELDS: {
                TEACHERS: { NAME: 'Name', EMAIL: 'Email', FIRST_NAME: 'First Name', LAST_NAME: 'Last Name', SECTIONS: 'Master Sections' },
                SECTIONS: { NAME: 'Section Name', SECTION_ID: 'Section ID', TEACHER_LINK: 'Teacher Link', STUDENT_ROSTER: 'Student Roster' },
                STUDENTS: { NAME: 'Name', EMAIL: 'Email', ID: 'ID', SECTIONS: 'Master Sections' },
                GRADES: { ASSIGNMENT: 'Assignment', STUDENT: 'Student', COMMENTS: 'Comments', FINAL_GRADE: 'Final Grade' }
            }
        };

        const Icon = ({ name, className = "w-5 h-5" }) => {
            useEffect(() => { lucide.createIcons(); }, []);
            return React.createElement('i', { 'data-lucide': name, className });
        };

        function GradingInterface() {
            const [step, setStep] = useState('teacher-select');
            const [isRecording, setIsRecording] = useState(false);
            const [recordingTime, setRecordingTime] = useState(0);
            const [teachers, setTeachers] = useState([]);
            const [selectedTeacher, setSelectedTeacher] = useState(null);
            const [sections, setSections] = useState([]);
            const [selectedSection, setSelectedSection] = useState(null);
            const [students, setStudents] = useState([]);
            const [assignmentName, setAssignmentName] = useState('');
            const [rubricItems, setRubricItems] = useState([
                { name: 'Correctness', maxPoints: 25 },
                { name: 'Method', maxPoints: 25 },
                { name: 'Clarity', maxPoints: 25 },
                { name: 'Completeness', maxPoints: 25 }
            ]);
            const [grades, setGrades] = useState({});
            const [currentStudent, setCurrentStudent] = useState(null);
            const [transcript, setTranscript] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [editingStudent, setEditingStudent] = useState(null);
            const [editingField, setEditingField] = useState(null);
            const [processingAudio, setProcessingAudio] = useState(false);
            const [sessionId, setSessionId] = useState(null);

            useEffect(() => {
                if (CONFIG.AIRTABLE_API_KEY === 'YOUR_AIRTABLE_API_KEY_HERE') {
                    setError('Please configure your Airtable API key in the CONFIG section.');
                }
                loadTeachersFromAirtable();
            }, []);

            useEffect(() => {
                let interval;
                if (isRecording) interval = setInterval(() => setRecordingTime(prev => prev + 1), 1000);
                return () => clearInterval(interval);
            }, [isRecording]);

            useEffect(() => {
                const handleKeyPress = (e) => {
                    if (e.code === 'Space' && isRecording && !editingStudent) {
                        e.preventDefault();
                        processCurrentAudioChunk();
                    }
                };
                window.addEventListener('keydown', handleKeyPress);
                return () => window.removeEventListener('keydown', handleKeyPress);
            }, [isRecording, editingStudent]);

            const airtableRequest = async (endpoint, options = {}) => {
                const url = `https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${endpoint}`;
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Authorization': `Bearer ${CONFIG.AIRTABLE_API_KEY}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                if (!response.ok) throw new Error(`Airtable API error: ${response.statusText}`);
                return response.json();
            };

            const loadTeachersFromAirtable = async () => {
                setLoading(true);
                setError(null);
                try {
                    const data = await airtableRequest(CONFIG.TABLES.TEACHERS);
                    const teachersList = data.records.map(record => ({
                        id: record.id,
                        name: record.fields[CONFIG.FIELDS.TEACHERS.NAME] || `${record.fields[CONFIG.FIELDS.TEACHERS.FIRST_NAME]} ${record.fields[CONFIG.FIELDS.TEACHERS.LAST_NAME]}`,
                        email: record.fields[CONFIG.FIELDS.TEACHERS.EMAIL]
                    }));
                    setTeachers(teachersList);
                } catch (err) {
                    console.error('Error loading teachers:', err);
                    setError('Failed to load teachers. Check configuration.');
                } finally {
                    setLoading(false);
                }
            };

            const selectTeacher = async (teacher) => {
                setSelectedTeacher(teacher);
                setLoading(true);
                setStep('class-select');
                setError(null);
                try {
                    const filterFormula = `SEARCH("${teacher.id}", ARRAYJOIN({${CONFIG.FIELDS.SECTIONS.TEACHER_LINK}}))`;
                    const data = await airtableRequest(`${CONFIG.TABLES.SECTIONS}?filterByFormula=${encodeURIComponent(filterFormula)}`);
                    const sectionsList = data.records.map(record => ({
                        id: record.id,
                        name: record.fields[CONFIG.FIELDS.SECTIONS.NAME],
                        studentCount: record.fields[CONFIG.FIELDS.SECTIONS.STUDENT_ROSTER]?.length || 0
                    }));
                    setSections(sectionsList);
                } catch (err) {
                    console.error('Error loading sections:', err);
                    setError('Failed to load sections.');
                } finally {
                    setLoading(false);
                }
            };

            const selectSection = async (section) => {
                setSelectedSection(section);
                setLoading(true);
                setStep('setup');
                setError(null);
                try {
                    const sectionData = await airtableRequest(`${CONFIG.TABLES.SECTIONS}/${section.id}`);
                    const studentIds = sectionData.fields[CONFIG.FIELDS.SECTIONS.STUDENT_ROSTER] || [];
                    const studentsPromises = studentIds.map(id => airtableRequest(`${CONFIG.TABLES.STUDENTS}/${id}`));
                    const studentsData = await Promise.all(studentsPromises);
                    const studentsList = studentsData.map(data => ({
                        id: data.id,
                        name: data.fields[CONFIG.FIELDS.STUDENTS.NAME],
                        email: data.fields[CONFIG.FIELDS.STUDENTS.EMAIL],
                        studentId: data.fields[CONFIG.FIELDS.STUDENTS.ID]?.toString() || 'N/A'
                    }));
                    setStudents(studentsList);
                    const initialGrades = {};
                    studentsList.forEach(student => {
                        initialGrades[student.id] = { scores: {}, comments: '', completed: false };
                    });
                    setGrades(initialGrades);
                } catch (err) {
                    console.error('Error loading students:', err);
                    setError('Failed to load students.');
                } finally {
                    setLoading(false);
                }
            };

            const startRecording = () => {
                setIsRecording(true);
                setTranscript([]);
                setSessionId(Date.now().toString());
            };

            const stopRecording = () => {
                setIsRecording(false);
                setCurrentStudent(null);
            };

            const processCurrentAudioChunk = () => {
                if (processingAudio) return;
                setProcessingAudio(true);
                setTranscript(prev => [...prev, { text: '⏳ Processing...', isProcessing: true }]);
                setTimeout(() => {
                    simulateNextStudent();
                    setProcessingAudio(false);
                    setTranscript(prev => prev.filter(t => !t.isProcessing));
                }, 2000);
            };

            const simulateNextStudent = () => {
                const ungradedStudents = students.filter(s => !grades[s.id]?.completed);
                if (ungradedStudents.length === 0) {
                    setTranscript(prev => [...prev, { text: '✅ All students graded!' }]);
                    return;
                }
                const nextStudent = ungradedStudents[0];
                setCurrentStudent(nextStudent.name);
                const baseScores = [23, 22, 24, 21];
                const randomScores = rubricItems.reduce((acc, item, idx) => {
                    acc[item.name] = baseScores[idx % baseScores.length];
                    return acc;
                }, {});
                const comments = [
                    'Excellent work showing all steps clearly.',
                    'Good effort. Need more intermediate steps.',
                    'Solid performance overall.',
                    'Outstanding analysis and methodology.'
                ];
                setTranscript(prev => [...prev, {
                    text: `${nextStudent.name}. ${Object.entries(randomScores).map(([k, v]) => `${k} ${v}`).join(', ')}. ${comments[ungradedStudents.indexOf(nextStudent) % comments.length]}`
                }]);
                setGrades(prev => ({
                    ...prev,
                    [nextStudent.id]: {
                        scores: randomScores,
                        comments: comments[ungradedStudents.indexOf(nextStudent) % comments.length],
                        completed: true
                    }
                }));
            };

            const saveToAirtable = async () => {
                setLoading(true);
                try {
                    const gradeRecords = Object.entries(grades).filter(([_, data]) => data.completed).map(([studentId, data]) => {
                        const fields = {
                            [CONFIG.FIELDS.GRADES.STUDENT]: [studentId],
                            [CONFIG.FIELDS.GRADES.COMMENTS]: data.comments,
                            [CONFIG.FIELDS.GRADES.FINAL_GRADE]: calculateTotal(data)
                        };
                        rubricItems.forEach(item => { fields[item.name] = data.scores[item.name] || 0; });
                        return { fields };
                    });
                    await airtableRequest(CONFIG.TABLES.GRADES, {
                        method: 'POST',
                        body: JSON.stringify({ records: gradeRecords })
                    });
                    alert('Successfully saved grades!');
                } catch (err) {
                    console.error('Error saving:', err);
                    alert('Error saving to Airtable.');
                } finally {
                    setLoading(false);
                }
            };

            const addRubricItem = () => setRubricItems([...rubricItems, { name: '', maxPoints: 10 }]);
            const removeRubricItem = (idx) => setRubricItems(rubricItems.filter((_, i) => i !== idx));
            const updateRubricItem = (idx, field, value) => {
                const updated = [...rubricItems];
                updated[idx][field] = value;
                setRubricItems(updated);
            };
            const startGrading = () => {
                if (!assignmentName.trim()) return alert('Enter assignment name');
                if (rubricItems.some(i => !i.name.trim())) return alert('Fill in all rubric items');
                setStep('grading');
            };
            const formatTime = (secs) => {
                const m = Math.floor(secs / 60);
                const s = secs % 60;
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };
            const calculateTotal = (sg) => sg.scores ? Object.values(sg.scores).reduce((sum, s) => sum + (s || 0), 0) : 0;
            const calculateMaxTotal = () => rubricItems.reduce((sum, item) => sum + (item.maxPoints || 0), 0);
            const getInitials = (name) => name.split(' ').map(n => n[0]).join('');
            const updateScore = (studentId, rubricItem, newScore) => {
                const maxPoints = rubricItems.find(i => i.name === rubricItem)?.maxPoints || 0;
                const validScore = Math.max(0, Math.min(newScore, maxPoints));
                setGrades(prev => ({
                    ...prev,
                    [studentId]: { ...prev[studentId], scores: { ...prev[studentId].scores, [rubricItem]: validScore } }
                }));
            };
            const updateComments = (studentId, newComments) => {
                setGrades(prev => ({
                    ...prev,
                    [studentId]: { ...prev[studentId], comments: newComments }
                }));
            };

            // Teacher Selection Screen
            if (step === 'teacher-select') {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="max-w-2xl w-full mx-auto px-6">
                            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
                                <h1 className="text-3xl font-bold text-gray-900 mb-2">Live Grading Assistant</h1>
                                <p className="text-gray-600 mb-6">Select your teacher profile</p>
                                {error && <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg"><p className="text-sm text-red-800">{error}</p></div>}
                                {loading ? (
                                    <div className="text-center py-8">
                                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                                        <p className="text-gray-500 mt-4">Loading...</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {teachers.map(teacher => (
                                            <button key={teacher.id} onClick={() => selectTeacher(teacher)} className="w-full text-left p-4 border border-gray-200 rounded-lg hover:border-blue-400 hover:bg-blue-50">
                                                <div className="flex items-center justify-between">
                                                    <div>
                                                        <p className="font-semibold text-gray-900">{teacher.name}</p>
                                                        <p className="text-sm text-gray-500">{teacher.email}</p>
                                                    </div>
                                                    <Icon name="play" />
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // Class Selection
            if (step === 'class-select') {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="max-w-2xl w-full mx-auto px-6">
                            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
                                <button onClick={() => setStep('teacher-select')} className="text-blue-600 hover:text-blue-700 mb-4 text-sm">← Back</button>
                                <h1 className="text-3xl font-bold text-gray-900 mb-2">Select Your Class</h1>
                                <p className="text-gray-600 mb-6">Teacher: {selectedTeacher?.name}</p>
                                {loading ? <div className="text-center py-8"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div></div> : (
                                    <div className="space-y-3">
                                        {sections.map(section => (
                                            <button key={section.id} onClick={() => selectSection(section)} className="w-full text-left p-4 border border-gray-200 rounded-lg hover:border-blue-400 hover:bg-blue-50">
                                                <div className="flex items-center justify-between">
                                                    <div>
                                                        <p className="font-semibold text-gray-900">{section.name}</p>
                                                        <p className="text-sm text-gray-500">{section.studentCount} students</p>
                                                    </div>
                                                    <Icon name="play" />
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // Setup Screen - Assignment & Rubric
            if (step === 'setup') {
                return (
                    <div className="min-h-screen bg-gray-50 py-12">
                        <div className="max-w-4xl mx-auto px-6">
                            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-8">
                                <button onClick={() => setStep('class-select')} className="text-blue-600 hover:text-blue-700 mb-4 text-sm">← Back</button>
                                <h1 className="text-3xl font-bold text-gray-900 mb-2">Assignment Setup</h1>
                                <p className="text-gray-600 mb-8">{selectedTeacher?.name} - {selectedSection?.name}</p>
                                
                                <div className="mb-8">
                                    <label className="block text-sm font-semibold text-gray-900 mb-2">Assignment Name</label>
                                    <input type="text" value={assignmentName} onChange={(e) => setAssignmentName(e.target.value)} placeholder="e.g., Unit 3 Test" className="w-full px-4 py-3 border border-gray-300 rounded-lg" />
                                </div>

                                <div className="mb-8">
                                    <div className="flex items-center justify-between mb-4">
                                        <label className="text-sm font-semibold text-gray-900">Rubric Items</label>
                                        <button onClick={addRubricItem} className="flex items-center gap-2 px-3 py-1.5 text-sm text-blue-600 hover:bg-blue-50 rounded-lg">
                                            <Icon name="plus" className="w-4 h-4" /> Add Item
                                        </button>
                                    </div>
                                    <div className="space-y-3">
                                        {rubricItems.map((item, idx) => (
                                            <div key={idx} className="flex gap-3">
                                                <input type="text" value={item.name} onChange={(e) => updateRubricItem(idx, 'name', e.target.value)} placeholder="Item name" className="flex-1 px-4 py-2 border border-gray-300 rounded-lg" />
                                                <input type="number" value={item.maxPoints} onChange={(e) => updateRubricItem(idx, 'maxPoints', parseInt(e.target.value) || 0)} className="w-24 px-4 py-2 border border-gray-300 rounded-lg" />
                                                <button onClick={() => removeRubricItem(idx)} disabled={rubricItems.length === 1} className="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                                    <Icon name="trash-2" className="w-5 h-5" />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                                        <p className="text-sm font-semibold text-blue-900">Total Points: {calculateMaxTotal()}</p>
                                    </div>
                                </div>

                                <div className="mb-8">
                                    <label className="block text-sm font-semibold text-gray-900 mb-2">Student Roster ({students.length} students)</label>
                                    <div className="bg-gray-50 rounded-lg p-4 max-h-48 overflow-y-auto">
                                        <div className="grid grid-cols-2 gap-2">
                                            {students.map(student => <div key={student.id} className="text-sm text-gray-700">• {student.name}</div>)}
                                        </div>
                                    </div>
                                </div>

                                <button onClick={startGrading} className="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg">Start Grading Session</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Grading Screen
            return (
                <div className="min-h-screen bg-gray-50">
                    <header className="bg-white border-b border-gray-200 px-6 py-4">
                        <div className="max-w-7xl mx-auto flex items-center justify-between">
                            <div>
                                <h1 className="text-2xl font-bold text-gray-900">{assignmentName}</h1>
                                <p className="text-sm text-gray-500 mt-1">{selectedTeacher?.name} - {selectedSection?.name}</p>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => setStep('setup')} className="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">Back</button>
                                <button onClick={saveToAirtable} className="flex items-center gap-2 px-4 py-2 text-white bg-green-600 hover:bg-green-700 rounded-lg">
                                    <Icon name="download" className="w-4 h-4" /> Save to Airtable
                                </button>
                            </div>
                        </div>
                    </header>

                    <div className="max-w-7xl mx-auto px-6 py-6">
                        <div className="grid grid-cols-3 gap-6">
                            <div className="col-span-1 space-y-6">
                                <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                    <h2 className="text-lg font-semibold text-gray-900 mb-4">Recording</h2>
                                    <div className="flex flex-col items-center gap-4">
                                        <button onClick={isRecording ? stopRecording : startRecording} className={`w-20 h-20 rounded-full flex items-center justify-center ${isRecording ? 'bg-red-500 hover:bg-red-600 animate-pulse' : 'bg-blue-500 hover:bg-blue-600'}`}>
                                            <Icon name={isRecording ? 'square' : 'mic'} className="w-8 h-8 text-white" />
                                        </button>
                                        <div className="text-center">
                                            <p className="text-sm font-medium text-gray-900">{isRecording ? 'Recording...' : 'Ready'}</p>
                                            <p className="text-2xl font-mono text-gray-600 mt-2">{formatTime(recordingTime)}</p>
                                            {currentStudent && <p className="text-sm text-blue-600 font-medium mt-2">Currently: {currentStudent}</p>}
                                            {processingAudio && <p className="text-sm text-orange-600 font-medium mt-2 animate-pulse">⏳ Processing...</p>}
                                        </div>
                                        {isRecording && (
                                            <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                                <p className="text-xs font-semibold text-blue-900 mb-1">How to use:</p>
                                                <p className="text-xs text-blue-800">🎤 Speak assessment<br/>⌨️ Press SPACE when done<br/>⏳ Wait 2-3 seconds<br/>🔄 Next student</p>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                    <h2 className="text-lg font-semibold text-gray-900 mb-4">Rubric Reference</h2>
                                    <div className="space-y-2">
                                        {rubricItems.map((item, idx) => (
                                            <div key={idx} className="flex justify-between">
                                                <span className="text-sm text-gray-700">{item.name}</span>
                                                <span className="text-sm font-semibold">/{item.maxPoints}</span>
                                            </div>
                                        ))}
                                        <div className="pt-2 border-t flex justify-between">
                                            <span className="text-sm font-semibold">Total</span>
                                            <span className="text-sm font-bold text-blue-600">/{calculateMaxTotal()}</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                    <h2 className="text-lg font-semibold text-gray-900 mb-4">Transcript</h2>
                                    <div className="h-96 overflow-y-auto bg-gray-50 rounded p-4 text-sm">
                                        {transcript.length === 0 ? (
                                            <p className="text-gray-400 italic">{isRecording ? 'Press SPACEBAR to process...' : 'Start recording'}</p>
                                        ) : (
                                            transcript.map((entry, idx) => (
                                                <p key={idx} className={`mb-3 ${entry.isProcessing ? 'text-orange-600 animate-pulse' : ''}`}>{entry.text}</p>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>

                            <div className="col-span-2">
                                <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                    <h2 className="text-lg font-semibold text-gray-900 mb-4">
                                        Student Progress ({Object.values(grades).filter(g => g.completed).length}/{students.length})
                                    </h2>
                                    <div className="space-y-3">
                                        {students.sort((a, b) => {
                                            if (currentStudent === a.name) return -1;
                                            if (currentStudent === b.name) return 1;
                                            const aC = grades[a.id]?.completed || false;
                                            const bC = grades[b.id]?.completed || false;
                                            if (aC && !bC) return 1;
                                            if (!aC && bC) return -1;
                                            return 0;
                                        }).map((student, idx) => {
                                            const sg = grades[student.id] || { scores: {}, comments: '', completed: false };
                                            const total = calculateTotal(sg);
                                            const colors = ['bg-blue-100 text-blue-600', 'bg-green-100 text-green-600', 'bg-purple-100 text-purple-600', 'bg-orange-100 text-orange-600'];
                                            const colorClass = colors[students.indexOf(student) % 4];

                                            return (
                                                <div key={student.id} className={`border rounded-lg p-4 ${currentStudent === student.name ? 'border-blue-500 bg-blue-50 shadow-md' : sg.completed ? 'border-green-300 bg-green-50' : 'border-gray-200'}`}>
                                                    <div className="flex items-start justify-between mb-3">
                                                        <div className="flex items-center gap-3">
                                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center font-semibold ${colorClass}`}>
                                                                {getInitials(student.name)}
                                                            </div>
                                                            <div>
                                                                <p className="font-semibold text-gray-900">{student.name}</p>
                                                                <p className="text-xs text-gray-500">ID: {student.studentId}</p>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <p className={`text-2xl font-bold ${sg.completed ? 'text-gray-900' : 'text-gray-400'}`}>{sg.completed ? total : '--'}</p>
                                                            <p className="text-xs text-gray-500">{sg.completed ? `/${calculateMaxTotal()}` : 'Not Graded'}</p>
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-4 gap-2 mb-3">
                                                        {rubricItems.map(item => {
                                                            const isEditing = editingStudent === student.id && editingField === item.name;
                                                            const score = sg.scores[item.name] || 0;
                                                            return (
                                                                <div key={item.name} className="text-center p-2 bg-white rounded border border-gray-200">
                                                                    <p className="text-xs text-gray-600 truncate mb-1">{item.name}</p>
                                                                    {isEditing ? (
                                                                        <input type="number" value={score} onChange={(e) => updateScore(student.id, item.name, parseInt(e.target.value) || 0)} onBlur={() => { setEditingStudent(null); setEditingField(null); }} onKeyDown={(e) => { if (e.key === 'Enter') { setEditingStudent(null); setEditingField(null); }}} min="0" max={item.maxPoints} autoFocus className="w-full text-lg font-semibold text-center border border-blue-500 rounded px-1" />
                                                                    ) : (
                                                                        <p onClick={() => { setEditingStudent(student.id); setEditingField(item.name); }} className={`text-lg font-semibold cursor-pointer hover:bg-blue-50 rounded px-1 ${sg.completed ? 'text-gray-900' : 'text-gray-400'}`} title="Click to edit">{score || '--'}</p>
                                                                    )}
                                                                    <p className="text-xs text-gray-500">/ {item.maxPoints}</p>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                    <div className={`${sg.completed ? 'bg-blue-50' : 'bg-gray-50'} rounded p-3`}>
                                                        <div className="flex items-center justify-between mb-1">
                                                            <p className={`text-xs font-semibold ${sg.completed ? 'text-blue-900' : 'text-gray-500'}`}>Comments:</p>
                                                            <button onClick={() => { if (editingStudent === student.id && editingField === 'comments') { setEditingStudent(null); setEditingField(null); } else { setEditingStudent(student.id); setEditingField('comments'); }}} className="text-xs text-blue-600 hover:text-blue-700 font-medium">{editingStudent === student.id && editingField === 'comments' ? 'Done' : 'Edit'}</button>
                                                        </div>
                                                        {editingStudent === student.id && editingField === 'comments' ? (
                                                            <textarea value={sg.comments} onChange={(e) => updateComments(student.id, e.target.value)} onBlur={() => { setTimeout(() => { setEditingStudent(null); setEditingField(null); }, 200); }} rows={3} autoFocus className="w-full text-sm p-2 border border-blue-500 rounded" />
                                                        ) : (
                                                            <p onClick={() => { setEditingStudent(student.id); setEditingField('comments'); }} className="text-sm text-gray-700 cursor-pointer hover:bg-blue-100 rounded p-1" title="Click to edit">{sg.comments || 'Click to add comments...'}</p>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<GradingInterface />, document.getElementById('root'));
    </script>
</body>
</html>
